var croct=function(){"use strict";function e(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var n=function e(){return this instanceof e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};n.prototype=t.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,r.get?r:{enumerable:!0,get:function(){return e[t]}})})),n}var t={},n={},r={},i=function(e,t){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},i(e,t)};function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var s=function(){return s=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},s.apply(this,arguments)};function a(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}function c(e,t,n,r){var i,o=arguments.length,s=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,n,s):i(t,n))||s);return o>3&&s&&Object.defineProperty(t,n,s),s}function u(e,t){return function(n,r){t(n,r,e)}}function l(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function d(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))}function h(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(s=0)),s;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,r=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}var p=Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]};function g(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||p(t,e,n)}function y(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function m(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s}function f(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(m(arguments[t]));return e}function v(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),i=0;for(t=0;t<n;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,i++)r[i]=o[s];return r}function b(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))}function w(e){return this instanceof w?(this.v=e,this):new w(e)}function T(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,i=n.apply(e,t||[]),o=[];return r={},s("next"),s("throw"),s("return"),r[Symbol.asyncIterator]=function(){return this},r;function s(e){i[e]&&(r[e]=function(t){return new Promise((function(n,r){o.push([e,t,n,r])>1||a(e,t)}))})}function a(e,t){try{(n=i[e](t)).value instanceof w?Promise.resolve(n.value.v).then(c,u):l(o[0][2],n)}catch(e){l(o[0][3],e)}var n}function c(e){a("next",e)}function u(e){a("throw",e)}function l(e,t){e(t),o.shift(),o.length&&a(o[0][0],o[0][1])}}function k(e){var t,n;return t={},r("next"),r("throw",(function(e){throw e})),r("return"),t[Symbol.iterator]=function(){return this},t;function r(r,i){t[r]=e[r]?function(t){return(n=!n)?{value:w(e[r](t)),done:!1}:i?i(t):t}:i}}function S(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e=y(e),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,i){(function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)})(r,i,(t=e[n](t)).done,t.value)}))}}}function P(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}var _=Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t};function O(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&p(t,e,n);return _(t,e),t}function E(e){return e&&e.__esModule?e:{default:e}}function C(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)}function x(e,t,n,r,i){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?i.call(e,n):i?i.value=n:t.set(e,n),n}function L(e,t){if(null===t||"object"!=typeof t&&"function"!=typeof t)throw new TypeError("Cannot use 'in' operator on non-object");return"function"==typeof e?t===e:e.has(t)}function j(e,t,n){if(null!=t){if("object"!=typeof t&&"function"!=typeof t)throw new TypeError("Object expected.");var r;if(n){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");r=t[Symbol.asyncDispose]}if(void 0===r){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");r=t[Symbol.dispose]}if("function"!=typeof r)throw new TypeError("Object not disposable.");e.stack.push({value:t,dispose:r,async:n})}else n&&e.stack.push({async:!0});return t}var I="function"==typeof SuppressedError?SuppressedError:function(e,t,n){var r=new Error(n);return r.name="SuppressedError",r.error=e,r.suppressed=t,r};function M(e){function t(t){e.error=e.hasError?new I(t,e.error,"An error was suppressed during disposal."):t,e.hasError=!0}return function n(){for(;e.stack.length;){var r=e.stack.pop();try{var i=r.dispose&&r.dispose.call(r.value);if(r.async)return Promise.resolve(i).then(n,(function(e){return t(e),n()}))}catch(e){t(e)}}if(e.hasError)throw e.error}()}var N,A={__extends:o,__assign:s,__rest:a,__decorate:c,__param:u,__metadata:l,__awaiter:d,__generator:h,__createBinding:p,__exportStar:g,__values:y,__read:m,__spread:f,__spreadArrays:v,__spreadArray:b,__await:w,__asyncGenerator:T,__asyncDelegator:k,__asyncValues:S,__makeTemplateObject:P,__importStar:O,__importDefault:E,__classPrivateFieldGet:C,__classPrivateFieldSet:x,__classPrivateFieldIn:L,__addDisposableResource:j,__disposeResources:M},$=Object.freeze({__proto__:null,__addDisposableResource:j,get __assign(){return s},__asyncDelegator:k,__asyncGenerator:T,__asyncValues:S,__await:w,__awaiter:d,__classPrivateFieldGet:C,__classPrivateFieldIn:L,__classPrivateFieldSet:x,__createBinding:p,__decorate:c,__disposeResources:M,__esDecorate:function(e,t,n,r,i,o){function s(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var a,c=r.kind,u="getter"===c?"get":"setter"===c?"set":"value",l=!t&&e?r.static?e:e.prototype:null,d=t||(l?Object.getOwnPropertyDescriptor(l,r.name):{}),h=!1,p=n.length-1;p>=0;p--){var g={};for(var y in r)g[y]="access"===y?{}:r[y];for(var y in r.access)g.access[y]=r.access[y];g.addInitializer=function(e){if(h)throw new TypeError("Cannot add initializers after decoration has completed");o.push(s(e||null))};var m=(0,n[p])("accessor"===c?{get:d.get,set:d.set}:d[u],g);if("accessor"===c){if(void 0===m)continue;if(null===m||"object"!=typeof m)throw new TypeError("Object expected");(a=s(m.get))&&(d.get=a),(a=s(m.set))&&(d.set=a),(a=s(m.init))&&i.unshift(a)}else(a=s(m))&&("field"===c?i.unshift(a):d[u]=a)}l&&Object.defineProperty(l,r.name,d),h=!0},__exportStar:g,__extends:o,__generator:h,__importDefault:E,__importStar:O,__makeTemplateObject:P,__metadata:l,__param:u,__propKey:function(e){return"symbol"==typeof e?e:"".concat(e)},__read:m,__rest:a,__runInitializers:function(e,t,n){for(var r=arguments.length>2,i=0;i<t.length;i++)n=r?t[i].call(e,n):t[i].call(e);return r?n:void 0},__setFunctionName:function(e,t,n){return"symbol"==typeof t&&(t=t.description?"[".concat(t.description,"]"):""),Object.defineProperty(e,"name",{configurable:!0,value:n?"".concat(n," ",t):t})},__spread:f,__spreadArray:b,__spreadArrays:v,__values:y,default:A}),U=e($),F={},R={},D={};function q(){if(N)return D;N=1,Object.defineProperty(D,"__esModule",{value:!0}),D.Violation=void 0;class e extends Error{constructor(e,t,n){super(e),this.path=t,this.params=n}}return D.Violation=e,D}var V,B={};function z(){if(V)return B;return V=1,Object.defineProperty(B,"__esModule",{value:!0}),B.formatPath=B.describe=void 0,B.describe=function(e){return null===e?"null":Array.isArray(e)?"array":"number"==typeof e?Number.isInteger(e)?"integer":"number":"object"==typeof e?e.constructor.name:typeof e},B.formatPath=function(e){return`/${e.join("/")}`},B}var Q,J={};var X,G={};var K,W={};var Y,Z={};var H,ee={};function te(){if(H)return ee;H=1,Object.defineProperty(ee,"__esModule",{value:!0}),ee.MixedSchema=void 0;return ee.MixedSchema=class{validate(){}},ee}var ne,re={};var ie,oe={};var se,ae={};var ce,ue={};var le,de,he={};function pe(){if(de)return F;de=1,Object.defineProperty(F,"__esModule",{value:!0}),F.tokenScopeSchema=void 0;const e=R;return F.tokenScopeSchema=new e.StringType({enumeration:["global","contextual","isolated"]}),F}!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.UnionType=e.StringType=e.ObjectType=e.NumberType=e.NullType=e.MixedSchema=e.JsonPrimitiveType=e.JsonObjectType=e.JsonArrayType=e.JsonType=e.FunctionType=e.BooleanType=e.ArrayType=void 0;const t=U;t.__exportStar(q(),e),t.__exportStar(z(),e);var n=function(){if(Q)return J;Q=1,Object.defineProperty(J,"__esModule",{value:!0}),J.ArrayType=void 0;const e=q(),t=z();return J.ArrayType=class{constructor(e={}){var t,n;this.definition={...e,minItems:null!==(t=e.minItems)&&void 0!==t?t:-1,maxItems:null!==(n=e.maxItems)&&void 0!==n?n:-1}}getTypes(){return["array"]}isValidType(e){return Array.isArray(e)}validate(n,r=[]){if(!this.isValidType(n))throw new e.Violation(`Expected value of type array at path '${(0,t.formatPath)(r)}', actual ${(0,t.describe)(n)}.`,r,{type:"string"});const{minItems:i,maxItems:o}=this.definition,{length:s}=n;if(i>=0&&i>s)throw new e.Violation(`Expected ${i===o?"exactly":"at least"} ${i} ${1===i?"item":"items"} at path '${(0,t.formatPath)(r)}', actual ${s}.`,r,{limit:i});if(o>=0&&o<s)throw new e.Violation(`Expected ${i===o?"exactly":"at most"} ${o} ${1===o?"item":"items"} at path '${(0,t.formatPath)(r)}', actual ${s}.`,r,{limit:o});if(void 0!==this.definition.items)for(let e=0;e<s;e++)this.definition.items.validate(n[e],r.concat([e.toString()]))}},J}();Object.defineProperty(e,"ArrayType",{enumerable:!0,get:function(){return n.ArrayType}});var r=function(){if(X)return G;X=1,Object.defineProperty(G,"__esModule",{value:!0}),G.BooleanType=void 0;const e=q(),t=z();return G.BooleanType=class{getTypes(){return["boolean"]}isValidType(e){return"boolean"==typeof e}validate(n,r=[]){if(!this.isValidType(n))throw new e.Violation(`Expected value of type boolean at path '${(0,t.formatPath)(r)}', actual ${(0,t.describe)(n)}.`,r,{type:"boolean"})}},G}();Object.defineProperty(e,"BooleanType",{enumerable:!0,get:function(){return r.BooleanType}});var i=function(){if(K)return W;K=1,Object.defineProperty(W,"__esModule",{value:!0}),W.FunctionType=void 0;const e=q(),t=z();return W.FunctionType=class{getTypes(){return["function"]}isValidType(e){return"function"==typeof e}validate(n,r=[]){if(!this.isValidType(n))throw new e.Violation(`Expected value of type function at path '${(0,t.formatPath)(r)}', actual ${(0,t.describe)(n)}.`,r,{type:"function"})}},W}();Object.defineProperty(e,"FunctionType",{enumerable:!0,get:function(){return i.FunctionType}});var o=function(){if(Y)return Z;Y=1,Object.defineProperty(Z,"__esModule",{value:!0}),Z.JsonType=Z.JsonPrimitiveType=Z.JsonArrayType=Z.JsonObjectType=void 0;const e=q(),t=z();function n(e){return null===e||"string"==typeof e||"boolean"==typeof e||"number"==typeof e}function r(e){return"[object Object]"===Object.prototype.toString.call(e)}function i(e){return Array.isArray(e)&&e.every(s)}function o(e){return r(e)&&Object.values(e).every(s)}function s(e){return n(e)||i(e)||o(e)}return Z.JsonObjectType=class{constructor(e={}){this.definition=e}getTypes(){return["object"]}isValidType(e){return r(e)}validate(n,r=[]){if(!o(n))throw new e.Violation(`Expected a JSON object at path '${(0,t.formatPath)(r)}', actual ${(0,t.describe)(n)}.`,r,{type:"object"});if(void 0!==this.definition.properties||void 0!==this.definition.propertyNames)for(const[e,t]of Object.entries(n)){const n=r.concat([e]);void 0!==this.definition.propertyNames&&this.definition.propertyNames.validate(e,n),void 0!==this.definition.properties&&this.definition.properties.validate(t,r.concat([e]))}}},Z.JsonArrayType=class{constructor(e={}){this.definition=e}getTypes(){return["array"]}isValidType(e){return Array.isArray(e)}validate(n,r=[]){if(!i(n))throw new e.Violation(`Expected a JSON array at path '${(0,t.formatPath)(r)}', actual ${(0,t.describe)(n)}.`,r,{type:"array"});if(void 0!==this.definition.items)for(let e=0;e<n.length;e++)this.definition.items.validate(n[e],r.concat([e.toString()]))}},Z.JsonPrimitiveType=class{getTypes(){return["null","number","string","boolean"]}isValidType(e){return n(e)}validate(n,r=[]){if(!this.isValidType(n))throw new e.Violation(`Expected a JSON primitive at path '${(0,t.formatPath)(r)}', actual ${(0,t.describe)(n)}.`,r,{type:this.getTypes().join("|")})}},Z.JsonType=class{getTypes(){return["null","number","string","boolean","array","object"]}isValidType(e){return n(e)||Array.isArray(e)||r(e)}validate(n,r=[]){if(!s(n))throw new e.Violation(`Expected a JSON value at path '${(0,t.formatPath)(r)}', actual ${(0,t.describe)(n)}.`,r,{type:this.getTypes().join("|")})}},Z}();Object.defineProperty(e,"JsonType",{enumerable:!0,get:function(){return o.JsonType}}),Object.defineProperty(e,"JsonArrayType",{enumerable:!0,get:function(){return o.JsonArrayType}}),Object.defineProperty(e,"JsonObjectType",{enumerable:!0,get:function(){return o.JsonObjectType}}),Object.defineProperty(e,"JsonPrimitiveType",{enumerable:!0,get:function(){return o.JsonPrimitiveType}});var s=te();Object.defineProperty(e,"MixedSchema",{enumerable:!0,get:function(){return s.MixedSchema}});var a=function(){if(ne)return re;ne=1,Object.defineProperty(re,"__esModule",{value:!0}),re.NullType=void 0;const e=q(),t=z();return re.NullType=class{getTypes(){return["null"]}isValidType(e){return null===e}validate(n,r=[]){if(!this.isValidType(n))throw new e.Violation(`Expected value of type null at path '${(0,t.formatPath)(r)}', actual ${(0,t.describe)(n)}.`,r,{type:"null"})}},re}();Object.defineProperty(e,"NullType",{enumerable:!0,get:function(){return a.NullType}});var c=function(){if(ie)return oe;ie=1,Object.defineProperty(oe,"__esModule",{value:!0}),oe.NumberType=void 0;const e=q(),t=z();return oe.NumberType=class{constructor(e={}){var t,n,r;this.definition={...e,integer:null!==(t=e.integer)&&void 0!==t&&t,minimum:null!==(n=e.minimum)&&void 0!==n?n:Number.NEGATIVE_INFINITY,maximum:null!==(r=e.maximum)&&void 0!==r?r:Number.POSITIVE_INFINITY}}getTypes(){return[this.definition.integer?"integer":"number"]}isValidType(e){return"number"==typeof e&&(!this.definition.integer||Number.isInteger(e))}validate(n,r=[]){if(!this.isValidType(n)){const i=this.getTypes()[0];throw new e.Violation(`Expected value of type ${i} at path '${(0,t.formatPath)(r)}', actual ${(0,t.describe)(n)}.`,r,{type:i})}if(n<this.definition.minimum)throw new e.Violation(`Expected a value greater than or equal to ${this.definition.minimum} at path '${(0,t.formatPath)(r)}', actual ${n}.`,r,{limit:this.definition.minimum});if(n>this.definition.maximum)throw new e.Violation(`Expected a value less than or equal to ${this.definition.maximum} at path '${(0,t.formatPath)(r)}', actual ${n}.`,r,{limit:this.definition.maximum})}},oe}();Object.defineProperty(e,"NumberType",{enumerable:!0,get:function(){return c.NumberType}});var u=function(){if(se)return ae;se=1,Object.defineProperty(ae,"__esModule",{value:!0}),ae.ObjectType=void 0;const e=q(),t=te(),n=z();return ae.ObjectType=class{constructor(e={}){var n,r,i,o,s,a;this.definition={...e,properties:null!==(n=e.properties)&&void 0!==n?n:{},required:null!==(r=e.required)&&void 0!==r?r:[],additionalProperties:null!==(i=e.additionalProperties)&&void 0!==i&&i,propertyNames:null!==(o=e.propertyNames)&&void 0!==o?o:new t.MixedSchema,minProperties:null!==(s=e.minProperties)&&void 0!==s?s:-1,maxProperties:null!==(a=e.maxProperties)&&void 0!==a?a:-1}}getTypes(){return void 0!==this.definition.type?[this.definition.type.name]:["object"]}isValidType(e){return void 0!==this.definition.type?e instanceof this.definition.type:"[object Object]"===Object.prototype.toString.call(e)}validate(t,r=[]){if(!this.isValidType(t)){const[i]=this.getTypes();throw new e.Violation(`Expected value of type ${i} at path '${(0,n.formatPath)(r)}', actual ${(0,n.describe)(t)}.`,r,{type:i})}const i=Object.entries(t),{minProperties:o,maxProperties:s}=this.definition;if(o>=0&&o>i.length)throw new e.Violation(`Expected ${o===s?"exactly":"at least"} ${o} ${1===o?"entry":"entries"} at path '${(0,n.formatPath)(r)}', actual ${i.length}.`,r,{limit:o});if(s>=0&&s<i.length)throw new e.Violation(`Expected ${o===s?"exactly":"at most"} ${s} ${1===s?"entry":"entries"} at path '${(0,n.formatPath)(r)}', actual ${i.length}.`,r,{limit:s});const a={...t};for(const i of this.definition.required)if(!(i in t))throw new e.Violation(`Missing property '${(0,n.formatPath)(r.concat([i]))}'.`,r,{required:i});for(const[t,o]of i){const i=r.concat([t]);this.definition.propertyNames.validate(t,i);const s=this.definition.properties[t];if(void 0===s){if(!1===this.definition.additionalProperties)throw new e.Violation(`Unknown property '${(0,n.formatPath)(i)}'.`,i,{additionalProperty:t});!0!==this.definition.additionalProperties&&this.definition.additionalProperties.validate(o,i)}else s.validate(o,i),delete a[t]}const{subtypes:c}=this.definition;if(void 0!==c){const e=t[c.discriminator];void 0!==e&&void 0!==c.schemas[e]&&c.schemas[e].validate(a,r)}}},ae}();Object.defineProperty(e,"ObjectType",{enumerable:!0,get:function(){return u.ObjectType}});var l=function(){if(ce)return ue;ce=1,Object.defineProperty(ue,"__esModule",{value:!0}),ue.StringType=void 0;const e=q(),t=z(),n={pointer:function(e){return/^(\.|([a-zA-Z_][a-zA-Z0-9_]*|\[[0-9]+])(\.[a-zA-Z_][a-zA-Z0-9_]*|\[[0-9]+])*)$/.test(e)},identifier:function(e){return/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(e)},uuid:function(e){return/^[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/.test(e)},date:function(e){return/^(\d\d\d\d)-(\d\d)-(\d\d)$/.test(e)},url:function(e){try{new URL(e)}catch{return!1}return!0}};return ue.StringType=class{constructor(e={}){var t,n,r;this.definition={...e,minLength:null!==(t=e.minLength)&&void 0!==t?t:-1,maxLength:null!==(n=e.maxLength)&&void 0!==n?n:-1,enumeration:null!==(r=e.enumeration)&&void 0!==r?r:[]}}getTypes(){return["string"]}isValidType(e){return"string"==typeof e}validate(r,i=[]){if(!this.isValidType(r))throw new e.Violation(`Expected value of type string at path '${(0,t.formatPath)(i)}', actual ${(0,t.describe)(r)}.`,i,{type:"string"});const{minLength:o,maxLength:s}=this.definition;if(o>=0&&o>r.length)throw new e.Violation(`Expected ${o===s?"exactly":"at least"} ${o} ${1===o?"character":"characters"} at path '${(0,t.formatPath)(i)}', actual ${r.length}.`,i,{limit:o});if(s>=0&&s<r.length)throw new e.Violation(`Expected ${o===s?"exactly":"at most"} ${s} ${1===s?"character":"characters"} at path '${(0,t.formatPath)(i)}', actual ${r.length}.`,i,{limit:s});const{enumeration:a}=this.definition;if(a.length>0&&a.indexOf(r)<0)throw new e.Violation(`Unexpected value at path '${(0,t.formatPath)(i)}', expecting '${1===a.length?a[0]:`${a.slice(0,-1).join("', '")}' or '${a.slice(-1)}`}', found '${r}'.`,i,{enumeration:a});const{format:c,pattern:u}=this.definition;if(void 0!==c&&!n[c](r))throw new e.Violation(`Invalid ${c} format at path '${(0,t.formatPath)(i)}'.`,i,{format:c});if(void 0!==u&&!u.test(r))throw new e.Violation(`Invalid format at path '${(0,t.formatPath)(i)}'.`,i,{pattern:u})}},ue}();Object.defineProperty(e,"StringType",{enumerable:!0,get:function(){return l.StringType}});var d=function(){if(le)return he;le=1,Object.defineProperty(he,"__esModule",{value:!0}),he.UnionType=void 0;const e=q(),t=z();return he.UnionType=class{constructor(e,t,...n){this.schemas=[e,t,...n]}getTypes(){const e=[];for(const t of this.schemas)for(const n of t.getTypes())e.indexOf(n)<0&&e.push(n);return e}isValidType(e){for(const t of this.schemas)if(t.isValidType(e))return!0;return!1}validate(n,r=[]){for(const e of this.schemas)if(e.isValidType(n))return void e.validate(n,r);const i=this.getTypes();throw new e.Violation(`Expected value of type ${i.slice(0,-1).join(", ")} or ${i[i.length-1]} at path '${(0,t.formatPath)(r)}', actual ${(0,t.describe)(n)}.`,r,{type:i.join("|")})}},he}();Object.defineProperty(e,"UnionType",{enumerable:!0,get:function(){return d.UnionType}})}(R);var ge,ye={};function me(){return ge||(ge=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.order=e.orderItem=e.cart=e.cartItem=e.productDetails=void 0;const t=R;e.productDetails=new t.ObjectType({required:["productId","name","displayPrice"],properties:{productId:new t.StringType({minLength:1,maxLength:50}),sku:new t.StringType({minLength:1,maxLength:50}),name:new t.StringType({minLength:1,maxLength:200}),category:new t.StringType({minLength:1,maxLength:100}),brand:new t.StringType({minLength:1,maxLength:100}),variant:new t.StringType({minLength:1,maxLength:50}),displayPrice:new t.NumberType({minimum:0}),originalPrice:new t.NumberType({minimum:0}),url:new t.StringType({format:"url"}),imageUrl:new t.StringType({format:"url"})}}),e.cartItem=new t.ObjectType({required:["index","product","quantity","total"],properties:{index:new t.NumberType({minimum:0}),product:e.productDetails,quantity:new t.NumberType({minimum:1}),total:new t.NumberType({minimum:0}),discount:new t.NumberType({minimum:0}),coupon:new t.StringType({minLength:1,maxLength:50})}}),e.cart=new t.ObjectType({required:["currency","items","total"],properties:{currency:new t.StringType({maxLength:10,minLength:1}),items:new t.ArrayType({items:e.cartItem}),subtotal:new t.NumberType({minimum:0}),shippingPrice:new t.NumberType({minimum:0}),taxes:new t.ObjectType({additionalProperties:new t.NumberType,minProperties:1}),costs:new t.ObjectType({additionalProperties:new t.NumberType,minProperties:1}),discount:new t.NumberType({minimum:0}),total:new t.NumberType({minimum:0}),coupon:new t.StringType({minLength:1,maxLength:50}),lastUpdateTime:new t.NumberType}}),e.orderItem=new t.ObjectType({required:["index","product","quantity","total"],properties:{index:new t.NumberType({minimum:0}),product:e.productDetails,quantity:new t.NumberType({minimum:1}),total:new t.NumberType({minimum:0}),discount:new t.NumberType({minimum:0}),coupon:new t.StringType({minLength:1,maxLength:50})}}),e.order=new t.ObjectType({required:["orderId","currency","items","total"],properties:{orderId:new t.StringType({minLength:1,maxLength:50}),currency:new t.StringType({maxLength:10,minLength:1}),items:new t.ArrayType({items:e.orderItem,minItems:1}),subtotal:new t.NumberType({minimum:0}),shippingPrice:new t.NumberType({minimum:0}),taxes:new t.ObjectType({additionalProperties:new t.NumberType,minProperties:1}),costs:new t.ObjectType({additionalProperties:new t.NumberType,minProperties:1}),discount:new t.NumberType({minimum:0}),total:new t.NumberType({minimum:0}),coupon:new t.StringType({minLength:1,maxLength:50}),paymentMethod:new t.StringType({minLength:1,maxLength:50}),installments:new t.NumberType({minimum:1}),status:new t.StringType({enumeration:["placed","paid","complete"]})}})}(ye)),ye}var fe,ve={};var be,we={};var Te,ke,Se={},Pe={},_e={};function Oe(){if(Te)return _e;Te=1,Object.defineProperty(_e,"__esModule",{value:!0}),_e.attributeNameSchema=void 0;const e=R;return _e.attributeNameSchema=new e.StringType({maxLength:50,format:"identifier"}),_e}function Ee(){if(ke)return Pe;ke=1,Object.defineProperty(Pe,"__esModule",{value:!0}),Pe.userProfileSchema=void 0;const e=R,t=Oe();return Pe.userProfileSchema=new e.ObjectType({properties:{firstName:new e.StringType({minLength:1,maxLength:50}),lastName:new e.StringType({minLength:1,maxLength:50}),birthDate:new e.StringType({format:"date"}),gender:new e.StringType({enumeration:["male","female","neutral","unknown"]}),email:new e.StringType({minLength:1,maxLength:254}),alternateEmail:new e.StringType({minLength:1,maxLength:254}),phone:new e.StringType({minLength:1,maxLength:30}),alternatePhone:new e.StringType({minLength:1,maxLength:30}),address:new e.ObjectType({properties:{street:new e.StringType({minLength:1,maxLength:100}),district:new e.StringType({minLength:1,maxLength:100}),city:new e.StringType({minLength:1,maxLength:100}),region:new e.StringType({minLength:1,maxLength:100}),country:new e.StringType({minLength:1,maxLength:100}),postalCode:new e.StringType({minLength:1,maxLength:20})}}),avatar:new e.StringType({maxLength:500,format:"url"}),company:new e.StringType({minLength:1,maxLength:200}),companyUrl:new e.StringType({maxLength:200,format:"url"}),jobTitle:new e.StringType({minLength:1,maxLength:50}),interests:new e.ArrayType({maxItems:30,items:new e.StringType({minLength:1,maxLength:30})}),activities:new e.ArrayType({maxItems:30,items:new e.StringType({minLength:1,maxLength:30})}),custom:new e.ObjectType({propertyNames:t.attributeNameSchema,maxProperties:10,additionalProperties:new e.UnionType(new e.BooleanType,new e.NullType,new e.NumberType,new e.StringType({maxLength:100}),new e.ArrayType({maxItems:10,items:new e.UnionType(new e.BooleanType,new e.NullType,new e.NumberType,new e.StringType({maxLength:100}),new e.ArrayType({maxItems:10,items:new e.UnionType(new e.BooleanType,new e.NullType,new e.NumberType,new e.StringType({maxLength:100}))}),new e.ObjectType({propertyNames:t.attributeNameSchema,maxProperties:10,additionalProperties:new e.UnionType(new e.BooleanType,new e.NullType,new e.NumberType,new e.StringType({maxLength:100}))}))}),new e.ObjectType({propertyNames:t.attributeNameSchema,maxProperties:10,additionalProperties:new e.UnionType(new e.BooleanType,new e.NullType,new e.NumberType,new e.StringType({maxLength:100}),new e.ArrayType({maxItems:10,items:new e.UnionType(new e.BooleanType,new e.NullType,new e.NumberType,new e.StringType({maxLength:100}))}),new e.ObjectType({propertyNames:t.attributeNameSchema,maxProperties:10,additionalProperties:new e.UnionType(new e.BooleanType,new e.NullType,new e.NumberType,new e.StringType({maxLength:100}))}))}))})}}),Pe}var Ce,xe,Le={};function je(){if(xe)return Se;xe=1,Object.defineProperty(Se,"__esModule",{value:!0}),Se.eventOccurred=Se.linkOpened=Se.postViewed=Se.interestShown=Se.goalCompleted=Se.userSignedUp=Se.productViewed=Se.orderPlaced=Se.checkoutStarted=Se.cartViewed=Se.cartModified=void 0;const e=R,t=me(),n=Ee(),r=function(){if(Ce)return Le;Ce=1,Object.defineProperty(Le,"__esModule",{value:!0}),Le.postDetails=void 0;const e=R;return Le.postDetails=new e.ObjectType({required:["postId","title","publishTime"],properties:{postId:new e.StringType({minLength:1,maxLength:200}),url:new e.StringType({format:"url"}),title:new e.StringType({minLength:1,maxLength:200}),tags:new e.ArrayType({items:new e.StringType({minLength:1,maxLength:50}),minItems:1,maxItems:10}),categories:new e.ArrayType({items:new e.StringType({minLength:1,maxLength:50}),minItems:1,maxItems:10}),authors:new e.ArrayType({items:new e.StringType({minLength:1,maxLength:50}),minItems:1,maxItems:10}),publishTime:new e.NumberType,updateTime:new e.NumberType}}),Le}();return Se.cartModified=new e.ObjectType({required:["cart"],properties:{cart:t.cart}}),Se.cartViewed=new e.ObjectType({required:["cart"],properties:{cart:t.cart}}),Se.checkoutStarted=new e.ObjectType({required:["cart"],properties:{cart:t.cart,orderId:new e.StringType({minLength:1,maxLength:50})}}),Se.orderPlaced=new e.ObjectType({required:["order"],properties:{order:t.order}}),Se.productViewed=new e.ObjectType({required:["product"],properties:{product:t.productDetails}}),Se.userSignedUp=new e.ObjectType({required:["userId"],properties:{userId:new e.StringType({minLength:1,maxLength:254}),profile:n.userProfileSchema}}),Se.goalCompleted=new e.ObjectType({required:["goalId"],properties:{goalId:new e.StringType({minLength:3,maxLength:100,pattern:/^[a-z0-9][a-z0-9:_-]+[a-z0-9]$/i}),value:new e.NumberType({minimum:0}),currency:new e.StringType({minLength:1,maxLength:10})}}),Se.interestShown=new e.ObjectType({required:["interests"],properties:{interests:new e.ArrayType({items:new e.StringType({minLength:1,maxLength:50}),minItems:1,maxItems:10})}}),Se.postViewed=new e.ObjectType({required:["post"],properties:{post:r.postDetails}}),Se.linkOpened=new e.ObjectType({required:["link"],properties:{link:new e.StringType}}),Se.eventOccurred=new e.ObjectType({required:["name"],properties:{name:new e.StringType({minLength:1,maxLength:50}),testId:new e.StringType({minLength:1,maxLength:50}),groupId:new e.StringType({minLength:1,maxLength:50}),personalizationId:new e.StringType({minLength:1,maxLength:50}),audience:new e.StringType({minLength:1,maxLength:50}),details:new e.ObjectType({additionalProperties:new e.UnionType(new e.NullType,new e.BooleanType,new e.NumberType,new e.StringType({maxLength:300})),propertyNames:new e.StringType({minLength:1,maxLength:20,format:"identifier"}),maxProperties:10})}}),Se}var Ie,Me={};function Ne(){if(Ie)return Me;Ie=1,Object.defineProperty(Me,"__esModule",{value:!0}),Me.loggerSchema=void 0;const e=R;return Me.loggerSchema=new e.ObjectType({required:["debug","info","warn","error"],additionalProperties:!0,properties:{debug:new e.FunctionType,info:new e.FunctionType,warn:new e.FunctionType,error:new e.FunctionType}}),Me}var Ae,$e={};var Ue,Fe,Re={},De={};function qe(){return Ue||(Ue=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.sdkConfigurationSchema=e.eventMetadataSchema=void 0;const t=R,n=pe(),r=Ne();e.eventMetadataSchema=new t.ObjectType({maxProperties:5,propertyNames:new t.StringType({minLength:1,maxLength:20,format:"identifier"}),additionalProperties:new t.StringType({maxLength:300})}),e.sdkConfigurationSchema=new t.ObjectType({required:["appId","tokenScope","disableCidMirroring","debug","test"],properties:{appId:new t.StringType({format:"uuid"}),clientId:new t.StringType({pattern:/^[0-9a-f]{32}$/i}),tokenScope:n.tokenScopeSchema,baseEndpointUrl:new t.StringType({format:"url"}),cidAssignerEndpointUrl:new t.StringType({format:"url"}),beaconQueueSize:new t.NumberType({minimum:0,integer:!0}),disableCidMirroring:new t.BooleanType,debug:new t.BooleanType,test:new t.BooleanType,logger:r.loggerSchema,urlSanitizer:new t.FunctionType,eventMetadata:e.eventMetadataSchema}})}(De)),De}var Ve,Be={};!function(e){Object.defineProperty(e,"__esModule",{value:!0});const t=U;t.__exportStar(pe(),e),t.__exportStar(me(),e),t.__exportStar(function(){if(fe)return ve;fe=1,Object.defineProperty(ve,"__esModule",{value:!0}),ve.evaluationOptionsSchema=void 0;const e=R;return ve.evaluationOptionsSchema=new e.ObjectType({properties:{timeout:new e.NumberType({integer:!0,minimum:0}),attributes:new e.JsonObjectType}}),ve}(),e),t.__exportStar(function(){if(be)return we;be=1,Object.defineProperty(we,"__esModule",{value:!0}),we.fetchOptionsSchema=void 0;const e=R;return we.fetchOptionsSchema=new e.ObjectType({properties:{timeout:new e.NumberType({integer:!0,minimum:0}),version:new e.UnionType(new e.StringType({pattern:/^\d+$/}),new e.NumberType({integer:!0,minimum:1})),preferredLocale:new e.StringType({pattern:/^[a-z]{2,3}([-_][a-z]{2,3})?$/i}),attributes:new e.JsonObjectType}}),we}(),e),t.__exportStar(je(),e),t.__exportStar(Ne(),e),t.__exportStar(function(){if(Ae)return $e;Ae=1,Object.defineProperty($e,"__esModule",{value:!0}),$e.removeOperation=$e.unsetOperation=$e.clearOperation=$e.incrementOperation=$e.decrementOperation=$e.mergeOperation=$e.combineOperation=$e.setOperation=$e.addOperation=void 0;const e=R,t=Oe(),n=new e.StringType({format:"pointer"}),r=new e.JsonArrayType({items:new e.JsonPrimitiveType}),i=new e.JsonObjectType({properties:new e.JsonPrimitiveType,propertyNames:t.attributeNameSchema}),o=new e.JsonObjectType({properties:new e.UnionType(new e.JsonPrimitiveType,r,i),propertyNames:t.attributeNameSchema}),s=new e.UnionType(r,o),a=new e.UnionType(new e.JsonPrimitiveType,r,o);return $e.addOperation=new e.ObjectType({required:["path","value"],properties:{path:n,value:a}}),$e.setOperation=new e.ObjectType({required:["path","value"],properties:{path:n,value:a}}),$e.combineOperation=new e.ObjectType({required:["path","value"],properties:{path:n,value:a}}),$e.mergeOperation=new e.ObjectType({required:["path","value"],properties:{path:n,value:s}}),$e.decrementOperation=new e.ObjectType({required:["path","value"],properties:{path:n,value:new e.NumberType}}),$e.incrementOperation=new e.ObjectType({required:["path","value"],properties:{path:n,value:new e.NumberType}}),$e.clearOperation=new e.ObjectType({required:["path"],properties:{path:n}}),$e.unsetOperation=new e.ObjectType({required:["path"],properties:{path:n}}),$e.removeOperation=new e.ObjectType({required:["path","value"],properties:{path:n,value:a}}),$e}(),e),t.__exportStar(function(){if(Fe)return Re;Fe=1,Object.defineProperty(Re,"__esModule",{value:!0}),Re.sdkFacadeConfigurationSchema=void 0;const e=R,t=pe(),n=qe(),r=Ne();return Re.sdkFacadeConfigurationSchema=new e.ObjectType({required:["appId"],properties:{appId:new e.StringType({format:"uuid"}),clientId:new e.StringType({pattern:/^[0-9a-f]{32}$/i}),tokenScope:t.tokenScopeSchema,disableCidMirroring:new e.BooleanType,debug:new e.BooleanType,test:new e.BooleanType,track:new e.BooleanType,logger:r.loggerSchema,urlSanitizer:new e.FunctionType,eventMetadata:n.eventMetadataSchema,userId:new e.UnionType(new e.StringType({minLength:1}),new e.NullType),token:new e.UnionType(new e.StringType({pattern:/^[A-Za-z0-9-_=]+\.[A-Za-z0-9-_=]+\.?[A-Za-z0-9-_.+/=]*$/}),new e.NullType),baseEndpointUrl:new e.StringType({format:"url"}),cidAssignerEndpointUrl:new e.StringType({format:"url"})}}),Re}(),e),t.__exportStar(qe(),e),t.__exportStar(function(){if(Ve)return Be;Ve=1,Object.defineProperty(Be,"__esModule",{value:!0}),Be.tokenSchema=void 0;const e=R;return Be.tokenSchema=new e.ObjectType({required:["headers","payload"],properties:{headers:new e.ObjectType({required:["typ","alg"],properties:{typ:new e.StringType,alg:new e.StringType,kid:new e.StringType,appId:new e.StringType({format:"uuid"})}}),payload:new e.ObjectType({required:["iss","aud","iat"],properties:{iss:new e.StringType,aud:new e.UnionType(new e.StringType,new e.ArrayType({items:new e.StringType})),iat:new e.NumberType({minimum:0}),sub:new e.StringType({minLength:1}),exp:new e.NumberType({minimum:0}),jti:new e.StringType({format:"uuid"})},additionalProperties:!0}),signature:new e.StringType}}),Be}(),e),t.__exportStar(Ee(),e)}(r);var ze={};Object.defineProperty(ze,"__esModule",{value:!0});var Qe=ze.formatCause=ze.formatMessage=void 0;function Je(e){const t=function(e){return e instanceof Error?e.message:"string"==typeof e&&""!==e?e:"unknown error"}(e);return 0===t.length?t:t.charAt(0).toUpperCase()+t.slice(1)}ze.formatMessage=Je,Qe=ze.formatCause=function(e){const t=Je(e);return 0===t.length?t:t.charAt(0).toLowerCase()+t.slice(1)},Object.defineProperty(n,"__esModule",{value:!0});var Xe=n.TabContextFactory=n.MinimalContextFactory=n.EvaluatorFacade=void 0;const Ge=r,Ke=ze;n.EvaluatorFacade=class{constructor(e){this.evaluator=e.evaluator,this.contextFactory=e.contextFactory,this.tokenProvider=e.userTokenProvider,this.cidAssigner=e.cidAssigner}async evaluate(e,t={}){var n;if("string"!=typeof e||0===e.length)throw new Error("The query must be a non-empty string.");return function(e){try{Ge.evaluationOptionsSchema.validate(e)}catch(e){throw new Error(`Invalid options: ${(0,Ke.formatCause)(e)}`)}}(t),this.evaluator.evaluate(e,{clientId:await this.cidAssigner.assignCid(),userToken:null!==(n=this.tokenProvider.getToken())&&void 0!==n?n:void 0,timeout:t.timeout,context:this.contextFactory.createContext(t.attributes)})}};n.MinimalContextFactory=class{createContext(e){return void 0===e?{}:{attributes:e}}};Xe=n.TabContextFactory=class{constructor(e){this.tab=e}createContext(e){var t;const n=new URL(this.tab.url),r={},i={title:this.tab.title,url:n.toString()},{referrer:o}=this.tab;o.length>0&&(i.referrer=o),r.page=i;const s=null!==(t=Intl.DateTimeFormat().resolvedOptions().timeZone)&&void 0!==t?t:null;return null!==s&&(r.timeZone=s),void 0!==e&&Object.keys(e).length>0&&(r.attributes=e),r}};var We={};Object.defineProperty(We,"__esModule",{value:!0}),We.TrackerFacade=void 0;const Ye=ze,Ze=r,He={cartViewed:Ze.cartViewed,cartModified:Ze.cartModified,checkoutStarted:Ze.checkoutStarted,orderPlaced:Ze.orderPlaced,productViewed:Ze.productViewed,userSignedUp:Ze.userSignedUp,eventOccurred:Ze.eventOccurred,interestShown:Ze.interestShown,postViewed:Ze.postViewed,goalCompleted:Ze.goalCompleted,linkOpened:Ze.linkOpened};function et(e,t){if("string"!=typeof e)throw new Error("The event type must of type string.");if("object"!=typeof t||null==t)throw new Error("The event payload must of type object.");const n={type:e,...t};return function(e){const{type:t,...n}=e;if(!(t in He))throw new Error(`Unknown event type '${t}'.`);try{He[t].validate(n)}catch(e){throw new Error(`Invalid event payload: ${(0,Ye.formatCause)(e)}`)}}(n),n}We.TrackerFacade=class{constructor(e){this.tracker=e}get flushed(){return this.tracker.flushed}enable(){this.tracker.enable()}disable(){this.tracker.disable()}addListener(e){this.tracker.addListener(e)}removeListener(e){this.tracker.removeListener(e)}track(e,t){return this.tracker.track(et(e,t))}};var tt={},nt={},rt={};Object.defineProperty(rt,"__esModule",{value:!0}),rt.ActiveRecord=void 0;const it=r,ot={add:it.addOperation,set:it.setOperation,merge:it.mergeOperation,combine:it.combineOperation,increment:it.incrementOperation,decrement:it.decrementOperation,clear:it.clearOperation,unset:it.unsetOperation,remove:it.removeOperation};rt.ActiveRecord=class{constructor(){this.operations=[]}set(e,t){return"string"==typeof e?this.pushOperation({type:"set",path:e,value:t}):this.pushOperation({type:"set",path:".",value:e})}add(e,t){return this.pushOperation({type:"add",path:e,value:t})}combine(e,t){return this.pushOperation({type:"combine",path:e,value:t})}merge(e,t){return"string"==typeof e?this.pushOperation({type:"merge",path:e,value:t}):this.pushOperation({type:"merge",path:".",value:e})}increment(e,t=1){return this.pushOperation({type:"increment",path:e,value:t})}decrement(e,t=1){return this.pushOperation({type:"decrement",path:e,value:t})}clear(e){return this.pushOperation({type:"clear",path:e})}unset(e){return this.pushOperation({type:"unset",path:e})}remove(e,t){return this.pushOperation({type:"remove",path:e,value:t})}pushOperation(e){const{type:t,...n}=e;return ot[t].validate(n),this.operations.push(e),this}reset(){return this.operations.splice(0),this}isDirty(){return this.operations.length>0}buildPatch(){return{operations:this.operations.slice()}}},Object.defineProperty(nt,"__esModule",{value:!0}),nt.UserPatch=void 0;const st=rt;class at extends st.ActiveRecord{constructor(e){super(),this.tracker=e}save(){if(!this.isDirty())return Promise.resolve({type:"userProfileChanged",patch:{operations:[]}});const e=this.tracker.track({type:"userProfileChanged",patch:this.buildPatch()});return this.reset(),e}}nt.UserPatch=at,Object.defineProperty(tt,"__esModule",{value:!0}),tt.UserFacade=void 0;const ct=nt;tt.UserFacade=class{constructor(e,t){this.context=e,this.tracker=t}isIdentified(){return!this.isAnonymous()}isAnonymous(){return this.context.isAnonymous()}edit(){return new ct.UserPatch(this.tracker)}};var ut,lt,dt={},ht={},pt={};function gt(){if(lt)return ht;lt=1,Object.defineProperty(ht,"__esModule",{value:!0}),ht.FixedTokenProvider=ht.Token=void 0;const e=function(){if(ut)return pt;function e(e){return(e+"===".slice((e.length+3)%4)).replace(/-/g,"+").replace(/_/g,"/")}function t(e){return e.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}return ut=1,Object.defineProperty(pt,"__esModule",{value:!0}),pt.base64UrlDecode=pt.base64UrlEncode=void 0,pt.base64UrlEncode=function(e,n=!1){return t(n?window.btoa(window.encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,((e,t)=>String.fromCharCode(Number.parseInt(t,16))))):window.btoa(e))},pt.base64UrlDecode=function(t,n=!1){return n?window.decodeURIComponent(Array.prototype.map.call(window.atob(e(t)),(e=>`%${`00${e.charCodeAt(0).toString(16)}`.slice(-2)}`)).join("")):window.atob(e(t))},pt}(),t=r,n=ze;class i{constructor(e,t,n=""){this.headers=e,this.payload=t,this.signature=n}static issue(e,t=null,n=Math.floor(Date.now()/1e3)){if(n<0)throw new Error("The timestamp must be non-negative.");if(""===t)throw new Error("The subject must be non-empty.");return new i({typ:"JWT",alg:"none",appId:e},{iss:"croct.io",aud:"croct.io",iat:n,...null!==t?{sub:t}:null})}static parse(t){if(""===t)throw new Error("The token cannot be empty.");const n=t.split(".",3);if(n.length<2)throw new Error("The token is malformed.");let r,o,s;try{r=JSON.parse((0,e.base64UrlDecode)(n[0],!0)),o=JSON.parse((0,e.base64UrlDecode)(n[1],!0)),3===n.length&&(s=(0,e.base64UrlDecode)(n[2],!1))}catch{throw new Error("The token is corrupted.")}return i.of(r,o,s)}static of(e,r,o=""){try{t.tokenSchema.validate({headers:e,payload:r,signature:o})}catch(e){throw new Error(`The token is invalid: ${(0,n.formatCause)(e)}`)}return new i(e,r,o)}getHeaders(){return{...this.headers}}getPayload(){return{...this.payload}}getSignature(){return this.signature}isAnonymous(){return void 0===this.payload.sub}getSubject(){return void 0!==this.payload.sub?this.payload.sub:null}getIssueTime(){return this.payload.iat}toJSON(){return this.toString()}toString(){return`${(0,e.base64UrlEncode)(JSON.stringify(this.headers),!0)}.${(0,e.base64UrlEncode)(JSON.stringify(this.payload),!0)}.${(0,e.base64UrlEncode)(this.signature,!1)}`}}ht.Token=i;return ht.FixedTokenProvider=class{constructor(e){this.token=e}getToken(){return this.token}},ht}var yt,mt={};var ft,vt={};var bt,wt={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.ReplicatedTokenStore=e.InMemoryTokenStore=e.CachedTokenStore=void 0;U.__exportStar(gt(),e);var t=function(){if(yt)return mt;yt=1,Object.defineProperty(mt,"__esModule",{value:!0}),mt.CachedTokenStore=void 0;const e=gt();return mt.CachedTokenStore=class{constructor(e){this.cache=e}getToken(){const t=this.cache.get();if(null===t)return null;try{return e.Token.parse(t)}catch(e){return null}}setToken(e){null!==e?this.cache.put(e.toString()):this.cache.clear()}},mt}();Object.defineProperty(e,"CachedTokenStore",{enumerable:!0,get:function(){return t.CachedTokenStore}});var n=(ft||(ft=1,Object.defineProperty(vt,"__esModule",{value:!0}),vt.InMemoryTokenStore=void 0,vt.InMemoryTokenStore=class{constructor(){this.token=null}getToken(){return this.token}setToken(e){this.token=e}}),vt);Object.defineProperty(e,"InMemoryTokenStore",{enumerable:!0,get:function(){return n.InMemoryTokenStore}});var r=(bt||(bt=1,Object.defineProperty(wt,"__esModule",{value:!0}),wt.ReplicatedTokenStore=void 0,wt.ReplicatedTokenStore=class{constructor(e,t){this.primary=e,this.secondary=t}getToken(){return this.primary.getToken()}setToken(e){this.primary.setToken(e),this.secondary.setToken(e)}}),wt);Object.defineProperty(e,"ReplicatedTokenStore",{enumerable:!0,get:function(){return r.ReplicatedTokenStore}})}(dt);var Tt,kt={},St={},Pt={},_t={};var Ot,Et={};var Ct,xt={};var Lt,jt={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.NullLogger=e.NamespacedLogger=e.ConsoleLogger=void 0;U.__exportStar((Tt||(Tt=1,Object.defineProperty(_t,"__esModule",{value:!0})),_t),e);var t=(Ot||(Ot=1,Object.defineProperty(Et,"__esModule",{value:!0}),Et.ConsoleLogger=void 0,Et.ConsoleLogger=class{constructor(e){this.namespace=e}get debug(){return this.bind(window.console.debug)}get info(){return this.bind(window.console.info)}get warn(){return this.bind(window.console.warn)}get error(){return this.bind(window.console.error)}bind(e){return void 0!==this.namespace?e.bind(window.console,`[${this.namespace}]`):e.bind(window.console)}}),Et);Object.defineProperty(e,"ConsoleLogger",{enumerable:!0,get:function(){return t.ConsoleLogger}});var n=(Ct||(Ct=1,Object.defineProperty(xt,"__esModule",{value:!0}),xt.NamespacedLogger=void 0,xt.NamespacedLogger=class{constructor(e,t){this.logger=e,this.namespace=t}debug(e){this.logger.debug(this.format(e))}info(e){this.logger.info(this.format(e))}warn(e){this.logger.warn(this.format(e))}error(e){this.logger.error(this.format(e))}format(e){return`[${this.namespace}] ${e}`}}),xt);Object.defineProperty(e,"NamespacedLogger",{enumerable:!0,get:function(){return n.NamespacedLogger}});var r=(Lt||(Lt=1,Object.defineProperty(jt,"__esModule",{value:!0}),jt.NullLogger=void 0,jt.NullLogger=class{debug(){}info(){}warn(){}error(){}}),jt);Object.defineProperty(e,"NullLogger",{enumerable:!0,get:function(){return r.NullLogger}})}(Pt);var It={},Mt={},Nt={};Object.defineProperty(Nt,"__esModule",{value:!0}),Nt.SynchronousEventManager=void 0;Nt.SynchronousEventManager=class{constructor(){this.listeners={}}addListener(e,t){var n;const r=null!==(n=this.listeners[e])&&void 0!==n?n:[];r.push(t),this.listeners[e]=r}removeListener(e,t){const n=this.listeners[e];if(void 0===n)return;const r=n.indexOf(t);r>=0&&n.splice(r,1)}dispatch(e,t){const n=this.listeners[e];void 0!==n&&n.forEach((e=>e(t)))}},Object.defineProperty(Mt,"__esModule",{value:!0}),Mt.Tab=void 0;const At=Nt,$t={focus:"focus",blur:"blur",beforeunload:"unload",DOMContentLoaded:"load",visibilitychange:"visibilityChange"};class Ut{constructor(e,t,n){this.eventManager=new At.SynchronousEventManager,this.id=e,this.isNew=t,this.urlSanitizer=n,this.initialize()}initialize(){const e=e=>{this.emit($t[e.type],new CustomEvent($t[e.type],{detail:{tab:this}}))};window.addEventListener("focus",e,!0),window.addEventListener("blur",e,!0),window.addEventListener("beforeunload",e,!0),window.addEventListener("DOMContentLoaded",e,!0),document.addEventListener("visibilitychange",(()=>{this.emit("visibilityChange",new CustomEvent("visibilityChange",{detail:{tab:this,visible:this.isVisible}}))}),!0),Ut.addUrlChangeListener((e=>{this.emit("urlChange",new CustomEvent("urlChange",{detail:{tab:this,url:this.sanitizeUrl(e)}}))}))}get url(){return this.sanitizeUrl(window.location.href)}get title(){return document.title}get referrer(){return""===document.referrer?"":this.sanitizeUrl(document.referrer)}get isVisible(){return"visible"===document.visibilityState}get document(){return document}addListener(e,t){this.eventManager.addListener(e,t)}removeListener(e,t){this.eventManager.removeListener(e,t)}sanitizeUrl(e){const t=window.encodeURI(window.decodeURI(e));return void 0!==this.urlSanitizer?this.urlSanitizer(t).toString():t}emit(e,t){this.eventManager.dispatch(e,t)}static addUrlChangeListener(e){let t=window.location.href;const n=()=>{const n=window.location.href;t!==n&&(e(n),t=n)},{pushState:r}=window.history;window.history.pushState=function(...e){const t=r.apply(window.history,e);return n(),t};const{replaceState:i}=window.history;window.history.replaceState=function(...e){const t=i.apply(window.history,e);return n(),t},window.addEventListener("popstate",n,!0)}}Mt.Tab=Ut;var Ft={};Object.defineProperty(Ft,"__esModule",{value:!0}),Ft.uuid4=void 0,Ft.uuid4=function(e=!1){let t="";if(e){const e=Date.now().toString(16).padStart(12,"0").substring(0,12);t=`${e.substring(0,8)}-${e.substring(8,12)}`}for(let e=t.length;e<36;e++)switch(e){case 8:case 13:case 18:case 23:t+="-";break;case 14:t+="4";break;default:{let n=16*Math.random()|0;19===e&&(n=3&n|8),t+=n.toString(16)}}return t},Object.defineProperty(It,"__esModule",{value:!0}),It.Context=void 0;const Rt=dt,Dt=Mt,qt=Ft;function Vt(e,t){return e===t||null!==e&&null!==t&&e.toString()===t.toString()}class Bt{constructor(e,t,n){this.tab=e,this.tokenStore=t,this.eventDispatcher=n,this.lastToken=t.getToken(),this.syncToken=this.syncToken.bind(this)}static load({cache:e,tokenScope:t,eventDispatcher:n,urlSanitizer:r}){let i=e.tabId.get(),o=!1;null===i&&(i=(0,qt.uuid4)(!0),o=!0);const s=new Dt.Tab(i,o,r);switch(e.tabId.clear(),s.addListener("unload",(()=>e.tabId.put(s.id))),t){case"isolated":return new Bt(s,new Rt.InMemoryTokenStore,n);case"global":{const t=new Bt(s,new Rt.CachedTokenStore(e.browserToken),n);return e.browserToken.addListener(t.syncToken),t}case"contextual":{const t=new Rt.CachedTokenStore(e.tabToken),r=new Rt.CachedTokenStore(e.browserToken);return s.isNew&&t.setToken(r.getToken()),s.addListener("visibilityChange",(e=>{e.detail.visible&&r.setToken(t.getToken())})),new Bt(s,new Rt.ReplicatedTokenStore(t,r),n)}}}getTab(){return this.tab}isAnonymous(){const e=this.getToken();return null==e||e.isAnonymous()}getUser(){const e=this.getToken();return null==e?null:e.getSubject()}getToken(){return this.tokenStore.getToken()}setToken(e){const t=this.lastToken;this.lastToken=e,this.tokenStore.setToken(e),Vt(t,e)||this.eventDispatcher.dispatch("tokenChanged",{oldToken:t,newToken:e})}syncToken(){const e=this.tokenStore.getToken(),t=this.lastToken;Vt(t,e)||(this.lastToken=e,this.eventDispatcher.dispatch("tokenChanged",{oldToken:t,newToken:e}))}}It.Context=Bt;var zt={};Object.defineProperty(zt,"__esModule",{value:!0}),zt.NamespacedStorage=void 0;zt.NamespacedStorage=class{constructor(e,t){if(""===t)throw new Error("The namespace cannot be empty.");this.storage=e,this.namespace=t}get length(){return this.getKeys().length}clear(){for(const e of this.getKeys())this.storage.removeItem(e)}getItem(e){return this.storage.getItem(this.getPrefixedKey(e))}key(e){const t=this.getKeys();return e>=t.length?null:t[e].substring(this.namespace.length+1)}removeItem(e){this.storage.removeItem(this.getPrefixedKey(e))}setItem(e,t){this.storage.setItem(this.getPrefixedKey(e),t)}getKeys(){const e=[],t=this.getPrefix();for(let n=0;n<this.storage.length;n++){const r=this.storage.key(n);null!==r&&0===r.indexOf(t)&&e.push(r)}return e}getPrefixedKey(e){return this.getPrefix()+e}getPrefix(){return`${this.namespace}.`}};var Qt,Jt={},Xt={};var Gt,Kt={};var Wt,Yt={};var Zt,Ht={};var en,tn={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.NeverPolicy=e.MaxAttemptsPolicy=e.BackoffPolicy=e.ArbitraryPolicy=void 0;U.__exportStar((Qt||(Qt=1,Object.defineProperty(Xt,"__esModule",{value:!0})),Xt),e);var t=(Gt||(Gt=1,Object.defineProperty(Kt,"__esModule",{value:!0}),Kt.ArbitraryPolicy=void 0,Kt.ArbitraryPolicy=class{constructor(e){if(e.length<1)throw new Error("The list of delays cannot be empty.");this.delays=[...e]}getDelay(e){return this.delays[Math.min(e<0?0:e,this.delays.length-1)]}shouldRetry(){return!0}}),Kt);Object.defineProperty(e,"ArbitraryPolicy",{enumerable:!0,get:function(){return t.ArbitraryPolicy}});var n=(Wt||(Wt=1,Object.defineProperty(Yt,"__esModule",{value:!0}),Yt.BackoffPolicy=void 0,Yt.BackoffPolicy=class{constructor(e={}){this.minRetryDelay=1e3,this.maxRetryDelay=3e4,this.backoffFactor=2,this.backoffJitter=1,this.maxAttempts=1/0;const{minRetryDelay:t=this.minRetryDelay,maxRetryDelay:n=this.maxRetryDelay,backoffFactor:r=this.backoffFactor,backoffJitter:i=this.backoffJitter,maxAttempts:o=this.maxAttempts}=e;if(t<0)throw new Error("The minimum retry delay must be non-negative.");if(n<t)throw new Error("The maximum retry delay must be greater than the minimum.");if(r<1)throw new Error("The backoff factor must be greater than zero.");if(i<0)throw new Error("The backoff jitter must be non-negative.");if(o<0)throw new Error("The maximum attempts must be non-negative.");this.minRetryDelay=t,this.maxRetryDelay=n,this.backoffFactor=r,this.backoffJitter=i,this.maxAttempts=o}getDelay(e){let t=Math.min(Math.max(this.backoffFactor**e,this.minRetryDelay),this.maxRetryDelay);if(this.backoffJitter>0){const e=Math.ceil(this.minRetryDelay),n=Math.floor(t);t=Math.floor(Math.random()*(n-e+1))+e}return t-=t%1,t}shouldRetry(e){return e<this.maxAttempts}}),Yt);Object.defineProperty(e,"BackoffPolicy",{enumerable:!0,get:function(){return n.BackoffPolicy}});var r=(Zt||(Zt=1,Object.defineProperty(Ht,"__esModule",{value:!0}),Ht.MaxAttemptsPolicy=void 0,Ht.MaxAttemptsPolicy=class{constructor(e,t){if(e<0)throw new Error("Delay must be non-negative.");if(t<0)throw new Error("Max attempts must be non-negative.");this.maxAttempts=t,this.delay=e}getDelay(){return this.delay}shouldRetry(e){return e<this.maxAttempts}}),Ht);Object.defineProperty(e,"MaxAttemptsPolicy",{enumerable:!0,get:function(){return r.MaxAttemptsPolicy}});var i=(en||(en=1,Object.defineProperty(tn,"__esModule",{value:!0}),tn.NeverPolicy=void 0,tn.NeverPolicy=class{getDelay(){return 1/0}shouldRetry(){return!1}}),tn);Object.defineProperty(e,"NeverPolicy",{enumerable:!0,get:function(){return i.NeverPolicy}})}(Jt);var nn,rn={},on={};var sn,an={};var cn,un={};var ln,dn={};var hn,pn={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.PersistentQueue=e.MonitoredQueue=e.InMemoryQueue=e.CapacityRestrictedQueue=void 0;U.__exportStar((nn||(nn=1,Object.defineProperty(on,"__esModule",{value:!0})),on),e);var t=(sn||(sn=1,Object.defineProperty(an,"__esModule",{value:!0}),an.CapacityRestrictedQueue=void 0,an.CapacityRestrictedQueue=class{constructor(e,t){this.queue=e,this.capacity=t}all(){return this.queue.all()}getCapacity(){return this.capacity}isEmpty(){return this.queue.isEmpty()}length(){return Math.min(this.capacity,this.queue.length())}peek(){return this.queue.peek()}push(e){if(this.queue.length()>=this.capacity)throw new Error("Maximum queue capacity reached.");this.queue.push(e)}shift(){return this.queue.shift()}}),an);Object.defineProperty(e,"CapacityRestrictedQueue",{enumerable:!0,get:function(){return t.CapacityRestrictedQueue}});var n=(cn||(cn=1,Object.defineProperty(un,"__esModule",{value:!0}),un.InMemoryQueue=void 0,un.InMemoryQueue=class{constructor(...e){this.queue=[],this.queue.unshift(...e)}all(){return this.queue.slice()}getCapacity(){return 1/0}isEmpty(){return 0===this.queue.length}push(e){this.queue.push(e)}peek(){var e;return null!==(e=this.queue[0])&&void 0!==e?e:null}shift(){const e=this.queue.shift();if(void 0===e)throw new Error("The queue is empty.");return e}length(){return this.queue.length}}),un);Object.defineProperty(e,"InMemoryQueue",{enumerable:!0,get:function(){return n.InMemoryQueue}});var r=function(){if(ln)return dn;ln=1,Object.defineProperty(dn,"__esModule",{value:!0}),dn.MonitoredQueue=void 0;const e=Pt;return dn.MonitoredQueue=class{constructor(t,n){this.callbacks={},this.queue=t,this.logger=null!=n?n:new e.NullLogger,this.updateStatus()}all(){return this.queue.all()}getCapacity(){return this.queue.getCapacity()}addCallback(e,t){var n;const r=null!==(n=this.callbacks[e])&&void 0!==n?n:[];switch(r.includes(t)||r.push(t),this.callbacks[e]=r,this.status){case e:t(this);break;case"empty":case"almostEmpty":"halfEmpty"===e&&t(this);break;case"full":case"almostFull":"halfFull"===e&&t(this)}}removeCallback(e,t){const n=this.callbacks[e];if(null==n)return;const r=n.indexOf(t);r>=0&&n.splice(r,1)}setStatus(e){this.status!==e&&(this.logger.debug(`Queue status changed to "${e}"`),this.report(e),this.status=e)}report(e){const t=this.callbacks[e];switch(void 0!==t&&t.forEach((e=>e(this))),e){case"empty":case"almostEmpty":this.report("halfEmpty");break;case"full":case"almostFull":this.report("halfFull")}}isEmpty(){return this.queue.isEmpty()}length(){return this.queue.length()}peek(){return this.queue.peek()}push(e){this.queue.push(e),this.updateStatus()}shift(){const e=this.queue.shift();return this.updateStatus(),e}updateStatus(){const e=this.queue.length(),t=this.getCapacity();e<=.5*t?0===e?this.setStatus("empty"):e<=.25*t?this.setStatus("almostEmpty"):this.setStatus("halfEmpty"):e>=t?this.setStatus("full"):e>=.75*t?this.setStatus("almostFull"):this.setStatus("halfFull")}},dn}();Object.defineProperty(e,"MonitoredQueue",{enumerable:!0,get:function(){return r.MonitoredQueue}});var i=(hn||(hn=1,Object.defineProperty(pn,"__esModule",{value:!0}),pn.PersistentQueue=void 0,pn.PersistentQueue=class{constructor(e,t="queue"){this.storage=e,this.key=t}all(){return this.queue.slice()}getCapacity(){return 1/0}isEmpty(){return 0===this.length()}length(){return this.queue.length}push(e){this.queue.push(e),this.flush()}peek(){const e=this.queue[0];return void 0===e?null:e}shift(){const e=this.queue.shift();if(void 0===e)throw new Error("The queue is empty.");return this.flush(),e}get queue(){return void 0===this.cache&&(this.cache=this.load()),this.cache}flush(){var e;this.storage.setItem(this.key,JSON.stringify(null!==(e=this.cache)&&void 0!==e?e:[]))}load(){const e=this.storage.getItem(this.key);if(null===e)return[];try{return JSON.parse(e)}catch(e){return[]}}}),pn);Object.defineProperty(e,"PersistentQueue",{enumerable:!0,get:function(){return i.PersistentQueue}})}(rn);var gn,yn={},mn={};gn=mn,Object.defineProperty(gn,"__esModule",{value:!0}),gn.isCartPartialEvent=gn.isIdentifiedUserEvent=gn.eventTypes=gn.miscEventTypes=gn.userEventTypes=gn.identifiedUserEventTypes=gn.ecommerceEventTypes=gn.cartEventTypes=gn.tabEventTypes=gn.pageEventTypes=void 0,gn.pageEventTypes=["pageLoaded","pageOpened"],gn.tabEventTypes=["tabOpened","tabUrlChanged","tabVisibilityChanged"],gn.cartEventTypes=["cartModified","cartViewed","checkoutStarted"],gn.ecommerceEventTypes=[...gn.cartEventTypes,"orderPlaced","productViewed"],gn.identifiedUserEventTypes=["userSignedIn","userSignedOut","userSignedUp"],gn.userEventTypes=[...gn.identifiedUserEventTypes,"userProfileChanged"],gn.miscEventTypes=["nothingChanged","sessionAttributesChanged","goalCompleted","interestShown","postViewed","eventOccurred","linkOpened"],gn.eventTypes=[...gn.pageEventTypes,...gn.ecommerceEventTypes,...gn.userEventTypes,...gn.miscEventTypes],gn.isIdentifiedUserEvent=function(e){return gn.identifiedUserEventTypes.includes(e.type)},gn.isCartPartialEvent=function(e){return gn.cartEventTypes.includes(e.type)},Object.defineProperty(yn,"__esModule",{value:!0}),yn.Tracker=void 0;const fn=Pt,vn=ze,bn=mn,wn={};yn.Tracker=class{constructor(e){var t;this.listeners=[],this.pending=[],this.state={enabled:!1,initialized:!1,suspended:!1},this.inactivityTimer={since:0};const{tab:n,tokenProvider:r,channel:i,logger:o,inactivityRetryPolicy:s,...a}=e;this.tab=n,this.tokenProvider=r,this.inactivityRetryPolicy=s,this.channel=i,this.logger=null!=o?o:new fn.NullLogger,this.options={...a,eventMetadata:null!==(t=a.eventMetadata)&&void 0!==t?t:{}},this.enable=this.enable.bind(this),this.disable=this.disable.bind(this),this.suspend=this.suspend.bind(this),this.unsuspend=this.unsuspend.bind(this),this.trackPageLoad=this.trackPageLoad.bind(this),this.trackTabVisibilityChange=this.trackTabVisibilityChange.bind(this),this.trackTabUrlChange=this.trackTabUrlChange.bind(this),this.trackInactivity=this.trackInactivity.bind(this)}addListener(e){this.listeners.push(e)}removeListener(e){let t=this.listeners.indexOf(e);for(;t>=0;)this.listeners.splice(t,1),t=this.listeners.indexOf(e)}get flushed(){const e=()=>{};return Promise.all(this.pending).then(e,e)}isEnabled(){return this.state.enabled}isSuspended(){return this.state.suspended}enable(){this.state.enabled||(this.logger.info("Tracker enabled"),this.state.enabled=!0,this.state.suspended||(this.startInactivityTimer(),this.state.initialized||(this.state.initialized=!0,this.initialize()),this.tab.addListener("load",this.trackPageLoad),this.tab.addListener("urlChange",this.trackTabUrlChange),this.tab.addListener("visibilityChange",this.trackTabVisibilityChange)))}disable(){this.state.enabled&&(this.logger.info("Tracker disabled"),this.state.enabled=!1,this.state.suspended||(this.tab.removeListener("load",this.trackPageLoad),this.tab.removeListener("urlChange",this.trackTabUrlChange),this.tab.removeListener("visibilityChange",this.trackTabVisibilityChange),this.stopInactivityTimer()))}suspend(){this.state.suspended||(this.logger.info("Tracker suspended"),this.state.enabled&&(this.disable(),this.state.enabled=!0),this.state.suspended=!0)}unsuspend(){this.state.suspended&&(this.logger.info("Tracker unsuspended"),this.state.suspended=!1,this.state.enabled&&(this.state.enabled=!1,this.enable()))}initialize(){void 0===wn[this.tab.id]&&(wn[this.tab.id]={});const e=wn[this.tab.id];this.tab.isNew&&!e.tabOpened&&(e.tabOpened=!0,this.trackTabOpen({tabId:this.tab.id})),e.pageOpened||(e.pageOpened=!0,this.trackPageOpen({url:this.tab.url,referrer:this.tab.referrer}))}stopInactivityTimer(){void 0!==this.inactivityTimer.id&&(window.clearTimeout(this.inactivityTimer.id),delete this.inactivityTimer.id)}startInactivityTimer(){this.stopInactivityTimer(),this.inactivityTimer.since=Date.now();let e=-1;const t=()=>{this.inactivityRetryPolicy.shouldRetry(e+1,this.inactivityTimer.since)?(e+=1,this.inactivityTimer.id=window.setTimeout((()=>{this.trackInactivity(),t()}),this.inactivityRetryPolicy.getDelay(e))):window.clearTimeout(this.inactivityTimer.id)};t()}track(e,t=Date.now()){return this.publish(this.enrichEvent(e,t),t).then((()=>e))}trackPageOpen({referrer:e,...t}){this.enqueue({type:"pageOpened",...t,...e.length>0?{referrer:e}:{}})}trackPageLoad({detail:{tab:e}}){this.enqueue({type:"pageLoaded",url:e.url,title:e.title,lastModifiedTime:Date.parse(e.document.lastModified)})}trackTabOpen(e){this.enqueue({type:"tabOpened",...e})}trackTabUrlChange({detail:e}){this.enqueue({type:"tabUrlChanged",tabId:e.tab.id,url:e.url})}trackTabVisibilityChange({detail:e}){this.enqueue({type:"tabVisibilityChanged",tabId:e.tab.id,visibility:e.visible?"visible":"hidden"})}trackInactivity(){this.enqueue({type:"nothingChanged",sinceTime:this.inactivityTimer.since})}enqueue(e,t=Date.now()){this.publish(e,t).catch((()=>{}))}notifyEvent(e){this.listeners.map((t=>t(e)))}publish(e,t){"nothingChanged"!==e.type&&this.stopInactivityTimer();const n=this.options.eventMetadata,r={tabId:this.tab.id,url:this.tab.url,...Object.keys(n).length>0?{metadata:n}:{}},i={event:e,context:r,timestamp:t,status:"pending"};return this.state.suspended?(this.logger.warn(`Tracker is suspended, ignoring event "${e.type}"`),this.notifyEvent({...i,status:"ignored"}),Promise.reject(new Error("The tracker is suspended."))):(this.logger.info(`Tracked event "${e.type}"`),this.notifyEvent(i),new Promise(((n,o)=>{const s=this.channel.publish(this.createBeacon(e,t,r)).then((()=>{this.logger.debug(`Successfully published event "${e.type}"`),this.notifyEvent({...i,status:"confirmed"}),n(e)}),(t=>{this.logger.error(`Failed to publish event "${e.type}", reason: ${(0,vn.formatCause)(t)}`),this.notifyEvent({...i,status:"failed"}),o(t)}));this.pending.push(s),s.finally((()=>{this.pending.splice(this.pending.indexOf(s),1)})),this.state.enabled&&"nothingChanged"!==e.type&&this.startInactivityTimer()})))}enrichEvent(e,t){if((0,bn.isCartPartialEvent)(e)){const{cart:{lastUpdateTime:n=t,...r},...i}=e;return{...i,cart:{...r,lastUpdateTime:n}}}return e}createBeacon(e,t,n){const r=this.tokenProvider.getToken();return{timestamp:t,...null!==r?{token:r.toString()}:{},context:n,payload:this.enrichBeaconPayload(this.createBeaconPayload(e))}}createBeaconPayload(e){if(!(0,bn.isIdentifiedUserEvent)(e))return e;if("userSignedUp"===e.type&&void 0!==e.profile){const{userId:t,profile:n,...r}=e;return{...r,externalUserId:t,patch:{operations:[{type:"merge",path:".",value:n}]}}}const{userId:t,...n}=e;return{...n,externalUserId:t}}enrichBeaconPayload(e){return"linkOpened"===e.type?{...e,link:new URL(e.link,this.tab.url).toString()}:e}};var Tn={},kn={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.CLIENT_LIBRARY=e.VERSION=e.MAX_QUERY_LENGTH=e.BASE_ENDPOINT_URL=void 0,e.BASE_ENDPOINT_URL="https://api.croct.io",e.MAX_QUERY_LENGTH=500,e.VERSION="0.14.0",e.CLIENT_LIBRARY=`Croct SDK JS v${e.VERSION}`}(kn);var Sn={};function Pn(e,t,n){if(t<0)throw Error("The start index cannot be negative.");if(n<t)throw new Error("The end index must greater than or equal to the start index.");let r,i;const o=[...e];let s=1,a=0;for(let e=0;e<o.length;e++){const c=o[e];if(e===t&&(r={index:e,line:s,column:a}),e===n){i={index:e,line:s,column:a};break}"\n"===c?(s+=1,a=0):a+=1}return void 0===r&&(r={index:o.length,line:s,column:a}),void 0===i&&(i={index:o.length,line:s,column:a}),{start:r,end:i}}Object.defineProperty(Sn,"__esModule",{value:!0}),Sn.getPosition=Sn.getLocation=Sn.getLength=void 0,Sn.getLength=function(e){return[...e].length},Sn.getLocation=Pn,Sn.getPosition=function(e,t){return Pn(e,t,t).start},Object.defineProperty(Tn,"__esModule",{value:!0}),Tn.Evaluator=Tn.QueryError=Tn.EvaluationError=Tn.EvaluationErrorType=void 0;const _n=kn,On=ze,En=Sn,Cn=Pt;var xn;!function(e){e.TIMEOUT="https://croct.help/api/evaluation#timeout",e.UNEXPECTED_ERROR="https://croct.help/api/evaluation#unexpected-error",e.INVALID_QUERY="https://croct.help/api/evaluation#invalid-query",e.TOO_COMPLEX_QUERY="https://croct.help/api/evaluation#too-complex-query",e.EVALUATION_FAILED="https://croct.help/api/evaluation#evaluation-failed",e.UNALLOWED_RESULT="https://croct.help/api/evaluation#unallowed-result",e.UNSERIALIZABLE_RESULT="https://croct.help/api/evaluation#unserializable-result"}(xn||(Tn.EvaluationErrorType=xn={}));class Ln extends Error{constructor(e){super(e.title),this.response=e,Object.setPrototypeOf(this,Ln.prototype)}}Tn.EvaluationError=Ln;class jn extends Ln{constructor(e){super(e),Object.setPrototypeOf(this,jn.prototype)}}Tn.QueryError=jn;class In{constructor(e){var t;if(void 0===e.appId==(void 0===e.apiKey))throw new Error("Either the application ID or the API key must be provided.");const{baseEndpointUrl:n,apiKey:r}=e;this.endpoint=(null!=n?n:_n.BASE_ENDPOINT_URL).replace(/\/+$/,"")+(void 0===r?"/client":"/external")+"/web/evaluate",this.configuration=e,this.logger=null!==(t=e.logger)&&void 0!==t?t:new Cn.NullLogger}evaluate(e,t={}){const n=(0,En.getLength)(e);if(n>In.MAX_QUERY_LENGTH){const t={title:"The query is too complex.",status:422,type:xn.TOO_COMPLEX_QUERY,detail:`The query must be at most ${In.MAX_QUERY_LENGTH} characters long, but it is ${n} characters long.`,errors:[{cause:"The query is longer than expected.",location:(0,En.getLocation)(e,0,Math.max(n-1,0))}]};return Promise.reject(new jn(t))}const r={query:e};return void 0!==t.context&&(r.context=t.context),new Promise(((e,n)=>{const i=new AbortController;void 0!==t.timeout&&setTimeout((()=>{const e={title:"Maximum evaluation timeout reached before evaluation could complete.",type:xn.TIMEOUT,detail:`The evaluation took more than ${t.timeout}ms to complete.`,status:408};i.abort(),n(new Ln(e))}),t.timeout);this.fetch(r,i.signal,t).then((t=>t.json().then((r=>{if(t.ok)return e(r);const i=r;switch(i.type){case xn.INVALID_QUERY:case xn.EVALUATION_FAILED:case xn.TOO_COMPLEX_QUERY:n(new jn(i));break;default:n(new Ln(i))}})).catch((e=>{if(!t.ok)throw new Error(`Error ${t.status} - ${t.statusText}`);throw e})))).catch((e=>{i.signal.aborted||n(new Ln({title:(0,On.formatMessage)(e),type:xn.UNEXPECTED_ERROR,detail:"Please try again or contact Croct support if the error persists.",status:500}))}))}))}fetch(e,t,n){var r;const{appId:i,apiKey:o}=this.configuration,{clientId:s,clientIp:a,userToken:c}=n,u=null!==(r=n.clientAgent)&&void 0!==r?r:n.userAgent;void 0!==n.userAgent&&this.logger.warn("The `userAgent` option is deprecated and will be removed in future releases. Please update the part of your code calling the `evaluate` method to use the `clientAgent` option instead.");const l={"Content-Type":"application/json"};return l["X-Client-Library"]=_n.CLIENT_LIBRARY,void 0!==o?l["X-Api-Key"]=o:void 0!==i&&(l["X-App-Id"]=i),void 0!==s&&(l["X-Client-Id"]=s),void 0!==a&&(l["X-Client-Ip"]=a),void 0!==c&&(l["X-Token"]=c.toString()),void 0!==u&&(l["X-Client-Agent"]=u),fetch(this.endpoint,{credentials:"omit",...n.extra,method:"POST",headers:l,signal:t,body:JSON.stringify(e)})}toJSON(){throw new Error("Unserializable value.")}}Tn.Evaluator=In,In.MAX_QUERY_LENGTH=_n.MAX_QUERY_LENGTH;var Mn={};Object.defineProperty(Mn,"__esModule",{value:!0}),Mn.encodeJson=void 0;Mn.encodeJson=function(e){return Promise.resolve(JSON.stringify(e))};var Nn,An={},$n={};var Un,Fn={};var Rn,Dn={};var qn,Vn={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.RemoteAssigner=e.FixedAssigner=e.CachedAssigner=void 0;U.__exportStar((Nn||(Nn=1,Object.defineProperty($n,"__esModule",{value:!0})),$n),e);var t=function(){if(Un)return Fn;Un=1,Object.defineProperty(Fn,"__esModule",{value:!0}),Fn.CachedAssigner=void 0;const e=Pt;return Fn.CachedAssigner=class{constructor(t,n,r={}){var i,o;this.assigner=t,this.cache=n,this.options={logger:null!==(i=r.logger)&&void 0!==i?i:new e.NullLogger,mirror:null!==(o=r.mirror)&&void 0!==o&&o}}async assignCid(e){var t;const n=this.cache.get(),r=null!==(t=null!=e?e:n)&&void 0!==t?t:null,{logger:i,mirror:o}=this.options;if(null===r){const e=await this.assigner.assignCid();return this.cache.put(e),i.debug("New CID stored into cache"),e}return i.debug("Using existing CID"),n!==r&&(i.debug("The cached CID is stale, updating cache..."),this.cache.put(r)),o&&(i.debug("Mirroring CID"),this.assigner.assignCid(r).then((e=>{e!==r&&(i.warn("The CID has changed, updating cache..."),this.cache.put(e))})).catch((()=>{i.error("Failed to mirror CID")}))),r}},Fn}();Object.defineProperty(e,"CachedAssigner",{enumerable:!0,get:function(){return t.CachedAssigner}});var n=(Rn||(Rn=1,Object.defineProperty(Dn,"__esModule",{value:!0}),Dn.FixedAssigner=void 0,Dn.FixedAssigner=class{constructor(e){this.cid=e}assignCid(){return Promise.resolve(this.cid)}}),Dn);Object.defineProperty(e,"FixedAssigner",{enumerable:!0,get:function(){return n.FixedAssigner}});var r=function(){if(qn)return Vn;qn=1,Object.defineProperty(Vn,"__esModule",{value:!0}),Vn.RemoteAssigner=void 0;const e=Pt,t=ze,n=kn;return Vn.RemoteAssigner=class{constructor(t,n){this.endpoint=t,this.logger=null!=n?n:new e.NullLogger}assignCid(e){return void 0===this.pending&&(this.pending=this.fetchCid(e).finally((()=>{this.pending=void 0}))),this.pending}async fetchCid(e){const r={method:"GET",credentials:"include",headers:{"X-Client-Library":n.CLIENT_LIBRARY}},i=new URL(this.endpoint);void 0!==e&&i.searchParams.set("cid",e);const o=await fetch(i,r);if(!o.ok){const e=new Error(`Failed to assign CID: ${(0,t.formatCause)(o.statusText)}`);throw this.logger.error(e.message),e}return this.logger.debug("New CID successfully assigned"),o.text()}},Vn}();Object.defineProperty(e,"RemoteAssigner",{enumerable:!0,get:function(){return r.RemoteAssigner}})}(An);var Bn,zn={},Qn={};var Jn,Xn={};var Gn,Kn={};var Wn,Yn={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.LocalStorageCache=e.InMemoryCache=e.FallbackCache=void 0;U.__exportStar((Bn||(Bn=1,Object.defineProperty(Qn,"__esModule",{value:!0})),Qn),e);var t=(Jn||(Jn=1,Object.defineProperty(Xn,"__esModule",{value:!0}),Xn.FallbackCache=void 0,Xn.FallbackCache=class{constructor(...e){this.caches=e}get(){for(const e of this.caches){const t=e.get();if(null!==t)return t}return null}put(e){this.caches.forEach((t=>t.put(e)))}clear(){this.caches.forEach((e=>e.clear()))}}),Xn);Object.defineProperty(e,"FallbackCache",{enumerable:!0,get:function(){return t.FallbackCache}});var n=(Gn||(Gn=1,Object.defineProperty(Kn,"__esModule",{value:!0}),Kn.InMemoryCache=void 0,Kn.InMemoryCache=class{constructor(e){this.cache=e}get(){var e;return null!==(e=this.cache)&&void 0!==e?e:null}put(e){this.cache=e}clear(){delete this.cache}}),Kn);Object.defineProperty(e,"InMemoryCache",{enumerable:!0,get:function(){return n.InMemoryCache}});var r=(Wn||(Wn=1,Object.defineProperty(Yn,"__esModule",{value:!0}),Yn.LocalStorageCache=void 0,Yn.LocalStorageCache=class{constructor(e,t){this.listeners=[],this.storage=e,this.key=t,this.value=e.getItem(t)}static autoSync(e){const t=e.sync.bind(e);return window.addEventListener("storage",t),()=>window.removeEventListener("storage",t)}get(){return this.value}put(e){this.storage.setItem(this.key,e),this.value!==e&&(this.value=e,this.notifyChange(e))}clear(){this.storage.removeItem(this.key),null!==this.value&&(this.value=null,this.notifyChange(null))}addListener(e){this.listeners.includes(e)||this.listeners.push(e)}removeListener(e){const t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}notifyChange(e){this.listeners.forEach((t=>t(e)))}sync(e){if(e.storageArea!==this.storage||null!==e.key&&e.key!==this.key)return;const t=this.storage.getItem(this.key);this.value!==t&&(this.value=t,this.notifyChange(t))}}),Yn);Object.defineProperty(e,"LocalStorageCache",{enumerable:!0,get:function(){return r.LocalStorageCache}})}(zn);var Zn={};Object.defineProperty(Zn,"__esModule",{value:!0}),Zn.GuaranteedChannel=Zn.TimeStamper=void 0;const Hn=Pt;Zn.TimeStamper=class{generate(){return String(Date.now())}};Zn.GuaranteedChannel=class{constructor({channel:e,logger:t,stamper:n,...r}){var i;this.closed=!1,this.channel=e,this.logger=null!=t?t:new Hn.NullLogger,this.stamper=n,this.options={...r,ackTimeout:null!==(i=r.ackTimeout)&&void 0!==i?i:5e3}}publish(e){return this.closed?Promise.reject(new Error("Channel is closed.")):new Promise(((t,n)=>{const r=this.stamper.generate(e);let i,o,s=!1;const a=Date.now(),c=e=>{if(e===r){s=!0;const e=Date.now()-a;window.clearTimeout(i),window.clearInterval(o),this.logger.debug(`Delivery confirmed #${r}, elapsed ${e}ms.`),this.channel.unsubscribe(c),t()}};this.channel.subscribe(c);const u=e=>{window.clearTimeout(i),window.clearInterval(o),this.logger.error(`Failed to send message #${r}`),this.channel.unsubscribe(c),n(e)};this.logger.debug(`Sending message #${r}...`),this.channel.publish({id:r,message:e}).then((()=>{s||(o=window.setInterval((()=>{this.closed&&u(new Error("Connection deliberately closed."))}),0),this.logger.debug(`Waiting confirmation #${r}...`),i=window.setTimeout((()=>{u(new Error("Maximum confirmation time reached."))}),this.options.ackTimeout))}),u)}))}close(){return this.closed=!0,this.channel.close()}};var er,tr={},nr={};var rr,ir={};var or,sr={};var ar,cr={};var ur,lr={};var dr,hr={};var pr,gr={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.SocketChannel=e.SandboxChannel=e.RetryChannel=e.QueuedChannel=e.GuaranteedChannel=e.EncodedChannel=e.BeaconSocketChannel=void 0;U.__exportStar((er||(er=1,Object.defineProperty(nr,"__esModule",{value:!0})),nr),e);var t=function(){if(rr)return ir;rr=1,Object.defineProperty(ir,"__esModule",{value:!0}),ir.BeaconSocketChannel=void 0;const e=Pt;return ir.BeaconSocketChannel=class{constructor(t){var n,r;this.listeners=[],this.connectionIndex=0,this.socketFactory=t.channelFactory,this.logger=null!==(n=t.logger)&&void 0!==n?n:new e.NullLogger,this.loggerFactory=null!==(r=t.loggerFactory)&&void 0!==r?r:()=>new e.NullLogger,this.cidAssigner=t.cidAssigner,this.cidParameter=t.cidParameter,this.trackerEndpointUrl=t.trackerEndpointUrl,this.tokenParameter=t.tokenParameter,this.notify=this.notify.bind(this)}async publish({id:e,message:t}){const{token:n,timestamp:r,context:i,payload:o}=JSON.parse(t);return this.token===n&&void 0!==this.socketChannel||(void 0!==this.socketChannel&&(this.logger.info("Connection no longer valid for current message."),this.socketChannel.unsubscribe(this.notify),await this.socketChannel.close()),this.token=n,this.socketChannel=await this.createSocketChannel(n)),this.socketChannel.publish(JSON.stringify({receiptId:e,originalTime:r,departureTime:Date.now(),context:i,payload:o}))}async createSocketChannel(e){const t=new URL(this.trackerEndpointUrl);t.searchParams.append(this.cidParameter,await this.cidAssigner.assignCid()),void 0!==e&&t.searchParams.append(this.tokenParameter,e);const n=this.socketFactory(t.toString(),this.loggerFactory(`WebSocket#${this.connectionIndex}`));return this.connectionIndex+=1,n.subscribe(this.notify),n}subscribe(e){this.listeners.includes(e)||this.listeners.push(e)}unsubscribe(e){const t=this.listeners.indexOf(e);t>=0&&this.listeners.splice(t,1)}notify(e){let t;try{t=JSON.parse(e)}catch{return void this.logger.error("Invalid JSON message received.")}const{violations:n=[],receiptId:r}=t;n.forEach((e=>this.logger.error(e.message))),null!==r&&this.listeners.forEach((e=>e(r)))}close(){return void 0===this.socketChannel?Promise.resolve():this.socketChannel.close()}},ir}();Object.defineProperty(e,"BeaconSocketChannel",{enumerable:!0,get:function(){return t.BeaconSocketChannel}});var n=(or||(or=1,Object.defineProperty(sr,"__esModule",{value:!0}),sr.EncodedChannel=void 0,sr.EncodedChannel=class{constructor(e,t){this.channel=e,this.encode=t}publish(e){return this.encode(e).then((e=>this.channel.publish(e)))}close(){return this.channel.close()}}),sr);Object.defineProperty(e,"EncodedChannel",{enumerable:!0,get:function(){return n.EncodedChannel}});var r=Zn;Object.defineProperty(e,"GuaranteedChannel",{enumerable:!0,get:function(){return r.GuaranteedChannel}});var i=function(){if(ar)return cr;ar=1,Object.defineProperty(cr,"__esModule",{value:!0}),cr.QueuedChannel=void 0;const e=Pt;return cr.QueuedChannel=class{constructor(t,n,r){this.closed=!1,this.channel=t,this.queue=n,this.logger=null!=r?r:new e.NullLogger}flush(){return void 0===this.pending?this.requeue():this.pending.catch(this.requeue.bind(this))}publish(e){return this.closed?Promise.reject(new Error("Channel is closed.")):this.queue.length()>=this.queue.getCapacity()?(this.logger.warn("The queue is full, message rejected."),Promise.reject(new Error("The queue is full."))):(void 0===this.pending&&(this.pending=this.queue.isEmpty()?Promise.resolve():Promise.reject(new Error("The queue must be flushed."))),this.enqueue(e),this.pending=this.pending.then((()=>this.channel.publish(e).then(this.dequeue.bind(this)))),this.pending)}enqueue(e){this.logger.debug("Enqueueing message..."),this.logger.debug(`Queue length: ${this.queue.length()+1}`),this.queue.push(e)}dequeue(){this.logger.debug("Dequeuing message..."),this.logger.debug(`Queue length: ${Math.max(0,this.queue.length()-1)}`),this.queue.shift()}requeue(){if(this.closed)return Promise.reject(new Error("Channel is closed."));if(this.pending=Promise.resolve(),this.queue.isEmpty())return this.pending;const e=this.queue.length();this.logger.debug("Requeuing messages..."),this.logger.debug(`Queue length: ${e}`);for(const e of this.queue.all())this.pending=this.pending.then((()=>this.channel.publish(e).then(this.dequeue.bind(this))));return this.pending}async close(){if(this.closed=!0,await this.channel.close(),void 0!==this.pending)try{await this.pending}catch{}}},cr}();Object.defineProperty(e,"QueuedChannel",{enumerable:!0,get:function(){return i.QueuedChannel}});var o=function(){if(ur)return lr;ur=1,Object.defineProperty(lr,"__esModule",{value:!0}),lr.RetryChannel=void 0;const e=Pt;return lr.RetryChannel=class{constructor({channel:t,retryPolicy:n,logger:r}){this.closed=!1,this.channel=t,this.retryPolicy=n,this.logger=null!=r?r:new e.NullLogger}publish(e){return this.closed?Promise.reject(new Error("The channel is closed.")):this.channel.publish(e).catch((t=>this.retry(e,t)))}async retry(e,t){let n=0;for(;this.retryPolicy.shouldRetry(n,e,t);){if(this.closed)throw new Error("Connection deliberately closed.");const t=this.retryPolicy.getDelay(n);this.logger.debug(`Retry attempt ${n+1}`),t>0&&(this.logger.debug(`Retry attempt delayed in ${t}ms`),await new Promise(((e,n)=>{const r=window.setInterval((()=>{this.closed&&(window.clearInterval(r),n(new Error("Connection deliberately closed.")))}),0);window.setTimeout((()=>{window.clearInterval(r),e()}),t)})));try{return await this.channel.publish(e)}catch{n+=1}}throw new Error("Maximum retry attempts reached.")}close(){return this.closed=!0,this.channel.close()}},lr}();Object.defineProperty(e,"RetryChannel",{enumerable:!0,get:function(){return o.RetryChannel}});var s=(dr||(dr=1,Object.defineProperty(hr,"__esModule",{value:!0}),hr.SandboxChannel=void 0,hr.SandboxChannel=class{constructor(){this.listeners=[],this.messages=[],this.closed=!1}publish(e){return this.messages.push(e),Promise.resolve()}notify(e){this.listeners.forEach((t=>t(e)))}subscribe(e){this.listeners.includes(e)||this.listeners.push(e)}unsubscribe(e){const t=this.listeners.indexOf(e);t>=0&&this.listeners.splice(t,1)}close(){return this.closed=!0,Promise.resolve()}isClosed(){return this.closed}}),hr);Object.defineProperty(e,"SandboxChannel",{enumerable:!0,get:function(){return s.SandboxChannel}});var a=function(){if(pr)return gr;pr=1,Object.defineProperty(gr,"__esModule",{value:!0}),gr.SocketChannel=void 0;const e=Pt,t=ze;return gr.SocketChannel=class{constructor({url:t,logger:n,...r}){var i,o,s;this.listeners=[],this.closed=!1,this.url=t,this.logger=null!=n?n:new e.NullLogger,this.options={...r,closeTimeout:null!==(i=r.closeTimeout)&&void 0!==i?i:5e3,connectionTimeout:null!==(o=r.connectionTimeout)&&void 0!==o?o:1e4,protocols:null!==(s=r.protocols)&&void 0!==s?s:[]}}get connected(){return void 0===this.connection?Promise.resolve(!1):this.connection.then((()=>!0),(()=>!1))}publish(e){return this.connect().then((t=>{t.send(e),this.logger.debug("Message sent.")}))}subscribe(e){this.listeners.includes(e)||this.listeners.push(e)}unsubscribe(e){const t=this.listeners.indexOf(e);t>=0&&this.listeners.splice(t,1)}notify(e){this.listeners.forEach((t=>t(e)))}connect(){return this.closed?Promise.reject(new Error("Channel has been closed.")):void 0!==this.connection?this.connection.then((e=>{if(e.readyState===WebSocket.OPEN)return e;throw new Error("Connection lost.")})).catch((()=>(delete this.connection,this.connect()))):(this.connection=new Promise(((e,n)=>{this.logger.debug("Connecting...");const r=new window.WebSocket(this.url,this.options.protocols);void 0!==this.options.binaryType&&(r.binaryType=this.options.binaryType);const i=window.setTimeout((()=>{const e="Maximum connection timeout reached.";this.logger.error(e),n(new Error(e)),r.close(1e3,e)}),this.options.connectionTimeout),o=()=>{window.clearTimeout(i),this.logger.info("Connection established."),r.removeEventListener("open",o),e(r)},s=()=>{this.closed||this.logger.error("Connection error.")},a=e=>{this.logger.debug("Message received."),this.notify(e.data)},c=e=>{var u;window.clearTimeout(i);const l=`Connection has been closed, reason: ${(0,t.formatCause)(null!==(u=e.reason)&&void 0!==u?u:"unknown")} (code ${e.code})`;this.closed||this.logger.info(l),r.removeEventListener("open",o),r.removeEventListener("error",s),r.removeEventListener("close",c),r.removeEventListener("message",a),n(new Error(l))};r.addEventListener("open",o,{once:!0}),r.addEventListener("close",c,{once:!0}),r.addEventListener("error",s),r.addEventListener("message",a)})),this.connection)}close(){return this.logger.debug("Closing connection..."),new Promise(((e,t)=>{if(this.closed=!0,void 0===this.connection)return this.logger.debug("Connection is not open."),void e();this.connection.then((n=>{let r;n.addEventListener("close",(()=>{window.clearTimeout(r),this.logger.info("Connection gracefully closed."),e()}),{once:!0}),n.close(1e3,"Deliberate disconnection."),r=window.setTimeout((()=>{this.logger.warn("Connection could not be closed within the timeout period."),t(new Error("Maximum close timeout reached."))}),this.options.closeTimeout)}),(()=>{this.logger.info("Connection closed."),e()}))}))}},gr}();Object.defineProperty(e,"SocketChannel",{enumerable:!0,get:function(){return a.SocketChannel}})}(tr);var yr={};Object.defineProperty(yr,"__esModule",{value:!0}),yr.ContentFetcher=yr.ContentError=yr.ContentErrorType=void 0;const mr=kn,fr=ze,vr=Pt;var br;!function(e){e.TIMEOUT="https://croct.help/api/content#timeout",e.UNEXPECTED_ERROR="https://croct.help/api/content#unexpected-error"}(br||(yr.ContentErrorType=br={}));class wr extends Error{constructor(e){super(e.title),this.response=e,Object.setPrototypeOf(this,wr.prototype)}}yr.ContentError=wr;class Tr{constructor(e){var t;if(void 0===e.appId==(void 0===e.apiKey))throw new Error("Either the application ID or the API key must be provided.");this.configuration=e;const{apiKey:n,baseEndpointUrl:r}=e,i=(null!=r?r:mr.BASE_ENDPOINT_URL).replace(/\/+$/,"")+(void 0===n?"/client":"/external")+"/web";this.dynamicEndpoint=`${i}/content`,this.staticEndpoint=`${i}/static-content`,this.logger=null!==(t=e.logger)&&void 0!==t?t:new vr.NullLogger}fetch(e,t={}){if(!0===t.static&&void 0===this.configuration.apiKey)throw new Error("The API key must be provided to fetch static content.");return new Promise(((n,r)=>{const i=new AbortController;void 0!==t.timeout&&setTimeout((()=>{const e={title:"Maximum timeout reached before content could be loaded.",type:br.TIMEOUT,detail:`The content took more than ${t.timeout}ms to load.`,status:408};i.abort(),r(new wr(e))}),t.timeout),this.load(e,i.signal,t).then((e=>e.json().then((t=>{e.ok?n(t):r(new wr(t))})).catch((t=>{if(!e.ok)throw new Error(`Error ${e.status} - ${e.statusText}`);throw t})))).catch((e=>{i.signal.aborted||r(new wr({title:(0,fr.formatMessage)(e),type:br.UNEXPECTED_ERROR,detail:"Please try again or contact Croct support if the error persists.",status:500}))}))}))}load(e,t,n){var r;const{apiKey:i,appId:o}=this.configuration,s={"Content-Type":"application/json"};s["X-Client-Library"]=mr.CLIENT_LIBRARY,void 0!==o&&(s["X-App-Id"]=o),void 0!==i&&(s["X-Api-Key"]=i);const a={slotId:e};void 0!==n.version&&(a.version=`${n.version}`),void 0!==n.preferredLocale&&(a.preferredLocale=n.preferredLocale);const c=Tr.isDynamicContent(n);if(c){void 0!==n.userAgent&&this.logger.warn("The `userAgent` option is deprecated and will be removed in future releases. Please update the part of your code calling the `fetch` method to use the `clientAgent` option instead."),void 0!==n.clientId&&(s["X-Client-Id"]=n.clientId),void 0!==n.clientIp&&(s["X-Client-Ip"]=n.clientIp),void 0!==n.userToken&&(s["X-Token"]=n.userToken.toString());const e=null!==(r=n.clientAgent)&&void 0!==r?r:n.userAgent;void 0!==e&&(s["X-Client-Agent"]=e),void 0!==n.context&&(a.context=n.context),void 0!==n.previewToken&&(a.previewToken=`${n.previewToken}`)}return fetch(c?this.dynamicEndpoint:this.staticEndpoint,{credentials:"omit",...n.extra,method:"POST",headers:s,signal:t,body:JSON.stringify(a)})}static isDynamicContent(e){return!0!==e.static}toJSON(){throw new Error("Unserializable value.")}}yr.ContentFetcher=Tr,Object.defineProperty(St,"__esModule",{value:!0}),St.Container=void 0;const kr=Pt,Sr=It,Pr=zt,_r=Jt,Or=rn,Er=dt,Cr=yn,xr=Tn,Lr=Mn,jr=An,Ir=Nt,Mr=zn,Nr=Zn,Ar=tr,$r=yr;St.Container=class{constructor(e){this.eventManager=new Ir.SynchronousEventManager,this.configuration=e}getConfiguration(){return this.configuration}getEvaluator(){return void 0===this.evaluator&&(this.evaluator=this.createEvaluator()),this.evaluator}createEvaluator(){return new xr.Evaluator({appId:this.configuration.appId,baseEndpointUrl:this.configuration.evaluationBaseEndpointUrl,logger:this.getLogger("Evaluator")})}getContentFetcher(){return void 0===this.contentFetcher&&(this.contentFetcher=this.createContentFetcher()),this.contentFetcher}createContentFetcher(){return new $r.ContentFetcher({appId:this.configuration.appId,baseEndpointUrl:this.configuration.contentBaseEndpointUrl,logger:this.getLogger("ContentFetcher")})}getPreviewTokenStore(){return void 0===this.previewTokenStore&&(this.previewTokenStore=new Er.CachedTokenStore(new Mr.LocalStorageCache(this.getGlobalBrowserStorage("preview"),"token"))),this.previewTokenStore}getTracker(){return void 0===this.tracker&&(this.tracker=this.createTracker()),this.tracker}createTracker(){const e=this.getContext(),t=new Cr.Tracker({tab:e.getTab(),tokenProvider:this.getUserTokenStore(),inactivityRetryPolicy:new _r.ArbitraryPolicy([3e4,3e4,12e4,12e4,3e5,3e5,9e5]),logger:this.getLogger("Tracker"),channel:this.getBeaconChannel(),eventMetadata:this.configuration.eventMetadata}),n=this.getBeaconQueue();return n.addCallback("halfEmpty",t.unsuspend),n.addCallback("full",t.suspend),t}getUserTokenStore(){if(void 0===this.userTokenProvider){const e=this.getContext();this.userTokenProvider={getToken:e.getToken.bind(e),setToken:e.setToken.bind(e)}}return this.userTokenProvider}getContext(){return void 0===this.context&&(this.context=this.createContext()),this.context}createContext(){const e=this.resolveStorageNamespace("token"),t=this.resolveStorageNamespace("tab"),n=this.getLocalStorage(),r=new Mr.LocalStorageCache(n,e),i=this.getSessionStorage();return this.removeTokenSyncListener=Mr.LocalStorageCache.autoSync(r),Sr.Context.load({tokenScope:this.configuration.tokenScope,eventDispatcher:this.getEventManager(),urlSanitizer:this.configuration.urlSanitizer,cache:{tabId:new Mr.LocalStorageCache(i,t),tabToken:new Mr.LocalStorageCache(i,e),browserToken:r}})}getBeaconChannel(){return void 0===this.beaconChannel&&(this.beaconChannel=this.createBeaconChannel()),this.beaconChannel}createBeaconChannel(){if(this.configuration.test)return new Ar.SandboxChannel;const e=this.getLogger("BeaconChannel"),{appId:t,trackerEndpointUrl:n}=this.configuration,r=new Ar.QueuedChannel(new Ar.RetryChannel({channel:new Ar.GuaranteedChannel({channel:new Ar.BeaconSocketChannel({trackerEndpointUrl:`${n}/${t}`,tokenParameter:"token",loggerFactory:this.getLogger.bind(this),logger:e,channelFactory:(e,t)=>new Ar.SocketChannel({url:e,logger:t}),cidAssigner:this.getCidAssigner(),cidParameter:"clientId"}),stamper:new Nr.TimeStamper,ackTimeout:1e4,logger:e}),retryPolicy:new _r.BackoffPolicy({minRetryDelay:1e3,maxRetryDelay:6e4,backoffFactor:1.5,backoffJitter:1}),logger:e}),this.getBeaconQueue(),e);return r.flush().catch((()=>{})),new Ar.EncodedChannel(r,Lr.encodeJson)}getCidAssigner(){return void 0===this.cidAssigner&&(this.cidAssigner=this.createCidAssigner()),this.cidAssigner}createCidAssigner(){if(void 0!==this.configuration.clientId)return new jr.FixedAssigner(this.configuration.clientId);if(this.configuration.test)return new jr.FixedAssigner("00000000-0000-0000-0000-000000000000");const e=this.getLogger("CidAssigner");return new jr.CachedAssigner(new jr.RemoteAssigner(this.configuration.cidAssignerEndpointUrl,e),new Mr.LocalStorageCache(this.getLocalStorage(),"croct.cid"),{logger:e,mirror:!this.configuration.disableCidMirroring})}getBeaconQueue(){return void 0===this.beaconQueue&&(this.beaconQueue=this.createBeaconQueue()),this.beaconQueue}createBeaconQueue(){const e=this.getContext().getTab();return new Or.MonitoredQueue(new Or.CapacityRestrictedQueue(new Or.PersistentQueue(this.getGlobalTabStorage("queue"),e.id),this.configuration.beaconQueueSize),this.getLogger("BeaconQueue"))}getLogger(...e){const t="Croct"+(0===e.length?"":`:${e.join(":")}`);return void 0!==this.configuration.logger?new kr.NamespacedLogger(this.configuration.logger,t):this.configuration.debug?new kr.ConsoleLogger(t):new kr.NullLogger}getTabStorage(e,...t){return this.getGlobalTabStorage("external",e,...t)}getBrowserStorage(e,...t){return this.getGlobalBrowserStorage("external",e,...t)}getGlobalTabStorage(e,...t){return new Pr.NamespacedStorage(this.getSessionStorage(),this.resolveStorageNamespace(e,...t))}getGlobalBrowserStorage(e,...t){return new Pr.NamespacedStorage(this.getLocalStorage(),this.resolveStorageNamespace(e,...t))}resolveStorageNamespace(e,...t){return`croct[${this.configuration.appId.toLowerCase()}].${[e].concat(t).join(".")}`}getLocalStorage(){return localStorage}getSessionStorage(){return sessionStorage}getEventManager(){return this.eventManager}async dispose(){const e=this.getLogger();void 0!==this.beaconChannel&&(e.debug("Closing beacon channel..."),await this.beaconChannel.close()),void 0!==this.removeTokenSyncListener&&(e.debug("Removing token sync listener..."),this.removeTokenSyncListener()),void 0!==this.tracker&&(void 0!==this.beaconQueue&&(e.debug("Removing queue listeners..."),this.beaconQueue.removeCallback("halfEmpty",this.tracker.unsuspend),this.beaconQueue.removeCallback("full",this.tracker.suspend)),e.debug("Suspending tracker..."),this.tracker.suspend(),await this.tracker.flushed),delete this.context,delete this.userTokenProvider,delete this.previewTokenStore,delete this.cidAssigner,delete this.tracker,delete this.evaluator,delete this.contentFetcher,delete this.beaconChannel,delete this.beaconQueue,delete this.removeTokenSyncListener,e.debug("Container resources released.")}},Object.defineProperty(kt,"__esModule",{value:!0}),kt.Sdk=void 0;const Ur=St,Fr=kn,Rr=r,Dr=ze;class qr{constructor(e){this.container=e}static init(e){var t;!function(e){if("object"!=typeof e||null===e)throw new Error("The configuration must be a key-value map.");try{Rr.sdkConfigurationSchema.validate(e)}catch(e){throw new Error(`Invalid configuration: ${(0,Dr.formatCause)(e)}`)}}(e);const{disableCidMirroring:n,eventMetadata:r={},baseEndpointUrl:i=Fr.BASE_ENDPOINT_URL,cidAssignerEndpointUrl:o,...s}=e,a={sdkVersion:Fr.VERSION};for(const e of Object.keys(r))a[`custom_${e}`]=r[e];const c=i.replace(/\/+$/,""),u=c.replace(/^http/i,"ws"),l=new Ur.Container({...s,disableCidMirroring:n,evaluationBaseEndpointUrl:c,contentBaseEndpointUrl:c,trackerEndpointUrl:`${u}/client/web/connect`,cidAssignerEndpointUrl:null!=o?o:`${c}/client/web/cid`,beaconQueueSize:null!==(t=s.beaconQueueSize)&&void 0!==t?t:100,eventMetadata:a}),d=l.getLogger(),{appId:h,tokenScope:p}=l.getConfiguration();d.debug("\n\n ██████ ██████   ██████   ██████ ████████ \n██      ██   ██ ██    ██ ██         ██    \n██      ██████  ██    ██ ██         ██    \n██      ██   ██ ██    ██ ██         ██    \n ██████ ██   ██  ██████   ██████    ██    \n\n"),d.info(`Initializing SDK v${Fr.VERSION}...`),d.debug(`App ID: ${h}`);const g=l.getContext(),y=g.getTab(),m=g.getUser();return d.debug(`${y.isNew?"New":"Current"} tab: ${y.id}`),d.debug(`Token scope: ${p}`),d.debug(`Current user: ${null!==m?m:"anonymous"}`),d.debug(`Test mode: ${s.test}`),d.info("⚡ Croct SDK is ready!"),new qr(l)}get appId(){const{appId:e}=this.container.getConfiguration();return e}get cidAssigner(){return this.container.getCidAssigner()}get previewTokenStore(){return this.container.getPreviewTokenStore()}get userTokenStore(){return this.container.getUserTokenStore()}get context(){return this.container.getContext()}get tracker(){return this.container.getTracker()}get evaluator(){return this.container.getEvaluator()}get contentFetcher(){return this.container.getContentFetcher()}get eventManager(){return this.container.getEventManager()}getLogger(...e){return this.container.getLogger(...e)}getTabStorage(e,...t){return this.container.getTabStorage(e,...t)}getBrowserStorage(e,...t){return this.container.getBrowserStorage(e,...t)}async close(){if(this.closed)return;const e=this.getLogger();e.debug("Closing SDK..."),this.closed=!0,await this.container.dispose(),e.info("SDK closed.")}}kt.Sdk=qr;var Vr={},Br={};Object.defineProperty(Br,"__esModule",{value:!0}),Br.SessionPatch=void 0;const zr=rt;class Qr extends zr.ActiveRecord{constructor(e){super(),this.tracker=e}save(){if(!this.isDirty())return Promise.resolve({type:"sessionAttributesChanged",patch:{operations:[]}});const e=this.tracker.track({type:"sessionAttributesChanged",patch:this.buildPatch()});return this.reset(),e}}Br.SessionPatch=Qr,Object.defineProperty(Vr,"__esModule",{value:!0}),Vr.SessionFacade=void 0;const Jr=Br;Vr.SessionFacade=class{constructor(e){this.tracker=e}edit(){return new Jr.SessionPatch(this.tracker)}};var Xr={};Object.defineProperty(Xr,"__esModule",{value:!0}),Xr.ContentFetcherFacade=void 0;const Gr=ze,Kr=r;Xr.ContentFetcherFacade=class{constructor(e){this.fetcher=e.contentFetcher,this.previewTokenProvider=e.previewTokenProvider,this.userTokenProvider=e.userTokenProvider,this.cidAssigner=e.cidAssigner,this.contextFactory=e.contextFactory}async fetch(e,t={}){var n,r;if("string"!=typeof e||0===e.length)throw new Error("The slot ID must be a non-empty string.");return function(e){try{Kr.fetchOptionsSchema.validate(e)}catch(e){throw new Error(`Invalid options: ${(0,Gr.formatCause)(e)}`)}}(t),this.fetcher.fetch(e,{static:!1,clientId:await this.cidAssigner.assignCid(),userToken:null!==(n=this.userTokenProvider.getToken())&&void 0!==n?n:void 0,previewToken:null!==(r=this.previewTokenProvider.getToken())&&void 0!==r?r:void 0,version:t.version,preferredLocale:t.preferredLocale,context:this.contextFactory.createContext(t.attributes),timeout:t.timeout})}},Object.defineProperty(t,"__esModule",{value:!0});var Wr=t.SdkFacade=void 0;const Yr=n,Zr=We,Hr=tt,ei=dt,ti=ze,ni=r,ri=kt,ii=Vr,oi=Xr;class si{constructor(e){this.sdk=e}static init(e){var t,n,r,i;!function(e){try{ni.sdkFacadeConfigurationSchema.validate(e)}catch(e){throw new Error(`Invalid configuration: ${(0,ti.formatCause)(e)}`)}}(e);const{track:o=!0,userId:s,token:a,...c}=e;if(void 0!==s&&void 0!==a)throw new Error("Either the user ID or token can be specified, but not both.");const u=new si(ri.Sdk.init({...c,tokenScope:null!==(t=c.tokenScope)&&void 0!==t?t:"global",debug:null!==(n=c.debug)&&void 0!==n&&n,test:null!==(r=c.test)&&void 0!==r&&r,disableCidMirroring:null!==(i=c.disableCidMirroring)&&void 0!==i&&i}));if(void 0!==s)if(null===s)u.unsetToken();else{const e=u.context.getToken();(null==e?void 0:e.getSubject())!==s&&u.identify(s)}else void 0!==a&&(null===a?u.unsetToken():u.setToken(ei.Token.parse(a)));return o&&u.tracker.enable(),u}get context(){return this.sdk.context}get cidAssigner(){return this.sdk.cidAssigner}get previewTokenStore(){return this.sdk.previewTokenStore}get userTokenStore(){return this.sdk.userTokenStore}get tracker(){return void 0===this.trackerFacade&&(this.trackerFacade=new Zr.TrackerFacade(this.sdk.tracker)),this.trackerFacade}get user(){return void 0===this.userFacade&&(this.userFacade=new Hr.UserFacade(this.context,this.sdk.tracker)),this.userFacade}get session(){return void 0===this.sessionFacade&&(this.sessionFacade=new ii.SessionFacade(this.sdk.tracker)),this.sessionFacade}get evaluator(){return void 0===this.evaluatorFacade&&(this.evaluatorFacade=new Yr.EvaluatorFacade({evaluator:this.sdk.evaluator,contextFactory:new Yr.TabContextFactory(this.sdk.context.getTab()),cidAssigner:this.sdk.cidAssigner,userTokenProvider:this.sdk.userTokenStore})),this.evaluatorFacade}get contentFetcher(){return void 0===this.contentFetcherFacade&&(this.contentFetcherFacade=new oi.ContentFetcherFacade({contentFetcher:this.sdk.contentFetcher,contextFactory:new Yr.TabContextFactory(this.sdk.context.getTab()),cidAssigner:this.sdk.cidAssigner,previewTokenProvider:this.sdk.previewTokenStore,userTokenProvider:this.sdk.userTokenStore})),this.contentFetcherFacade}get eventManager(){const{eventManager:e}=this.sdk;return{addListener:e.addListener.bind(e),removeListener:e.removeListener.bind(e),dispatch:(t,n)=>{if(!/[a-z][a-z_]+\.[a-z][a-z_]+/i.test(t))throw new Error('The event name must be in the form of "namespaced.eventName", where both the namespace and event name must start with a letter, followed by any series of letters and underscores.');e.dispatch(t,n)}}}identify(e){this.setToken(ei.Token.issue(this.sdk.appId,e))}anonymize(){this.context.isAnonymous()||this.unsetToken()}getToken(){return this.context.getToken()}setToken(e){var t;const n=this.getToken();if(null!==n&&n.toString()===e.toString())return;const r=null!==(t=null==n?void 0:n.getSubject())&&void 0!==t?t:null,i=e.getSubject(),o=this.getLogger();if(i===r)return this.context.setToken(e),void o.debug("Token refreshed");null!==r&&(this.trackInternalEvent({type:"userSignedOut",userId:r}),o.info("User signed out")),this.context.setToken(e),null!==i&&(this.trackInternalEvent({type:"userSignedIn",userId:i}),o.info(`User signed in as ${i}`)),o.debug("New token saved, ")}unsetToken(){const e=this.getToken();if(null===e)return;const t=this.getLogger(),n=e.getSubject();null!==n&&(this.trackInternalEvent({type:"userSignedOut",userId:n}),t.info("User signed out")),this.context.setToken(null),t.debug("Token removed")}trackInternalEvent(e){this.sdk.tracker.track(e).catch((()=>{}))}getLogger(...e){return this.sdk.getLogger(...e)}getTabStorage(e,...t){return this.sdk.getTabStorage(e,...t)}getBrowserStorage(e,...t){return this.sdk.getBrowserStorage(e,...t)}close(){return this.sdk.close()}}Wr=t.SdkFacade=si;var ai={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.VERSION=e.Sdk=void 0;const t=kn;Object.defineProperty(e,"VERSION",{enumerable:!0,get:function(){return t.VERSION}});const n=kt;Object.defineProperty(e,"Sdk",{enumerable:!0,get:function(){return n.Sdk}})}(ai);const ci="https://play.croct.com";class ui{constructor(e){this.sdkVersion=e.sdkVersion,this.appId=e.appId,this.connectionId=e.connectionId,this.tab=e.tab,this.contextFactory=e.contextFactory,this.storage=e.storage,this.eventSubscriber=e.eventSubscriber,this.cidAssigner=e.cidAssigner,this.tokenProvider=e.tokenProvider,this.logger=e.logger}enable(){const e=this.resolveConnectionId();if(null!==e)return this.syncListener=()=>this.cidAssigner.assignCid().then((t=>{this.syncToken(e,t)})).catch((e=>{this.logger.warn(`Sync failed: ${Qe(e)}`)})),this.eventSubscriber.addListener("tokenChanged",this.syncListener),this.tab.addListener("urlChange",this.syncListener),this.syncListener()}resolveConnectionId(){if(void 0!==this.connectionId)return this.logger.debug("Connection ID passed in configuration"),this.connectionId;let e=new URL(this.tab.url).searchParams.get("__cplay");return null===e||""===e?(this.logger.debug("No connection ID found in URL"),e=this.storage.getItem("connectionId"),this.logger.debug(null!==e?"Previous connection ID found":"No previous connection ID found"),e):(this.logger.debug("Connection ID found in URL"),this.storage.setItem("connectionId",e),e)}disable(){void 0!==this.syncListener&&(this.eventSubscriber.removeListener("tokenChanged",this.syncListener),this.tab.removeListener("urlChange",this.syncListener),delete this.syncListener)}syncToken(e,t){const n=document.createElement("iframe");n.setAttribute("src","https://play.croct.com/connect.html"),n.setAttribute("sandbox","allow-scripts allow-same-origin"),n.style.visibility="hidden",n.style.opacity="0",n.style.border="0",n.style.width="0",n.style.height="0";const r=this.createContext();n.onload=()=>{var i,o;if(null===n.contentWindow)return document.body.contains(n)&&document.body.removeChild(n),void this.logger.warn("Sync handshake failed");const s=t=>{t.origin===ci&&t.data===e&&(window.removeEventListener("message",s),document.body.contains(n)&&document.body.removeChild(n),this.logger.debug("Sync completed"))};window.addEventListener("message",s);const a={appId:this.appId,connectionId:e,sdkVersion:this.sdkVersion,tabId:this.tab.id,cid:t,token:null!==(o=null===(i=this.tokenProvider.getToken())||void 0===i?void 0:i.toString())&&void 0!==o?o:null,context:r};n.contentWindow.postMessage(a,ci),this.logger.debug("Waiting for sync acknowledgment...")},this.logger.debug("Sync started");const i=()=>{document.body.appendChild(n)};null===document.body?document.addEventListener("DOMContentLoaded",i):i()}createContext(){const{page:e,campaign:t,timeZone:n}=this.contextFactory.createContext(),r={};return void 0!==e&&(r.page=e),void 0!==t&&(r.campaign=t),void 0!==n&&(r.timeZone=n),r}}const li=e=>{const{sdk:t,options:n}=e;return new ui({sdkVersion:t.version,appId:t.appId,connectionId:n.connectionId,tab:t.tab,storage:t.getTabStorage(),tokenProvider:t.userTokenStore,cidAssigner:t.cidAssigner,contextFactory:new Xe(t.tab),eventSubscriber:t.eventManager,logger:t.getLogger()})},di="croct-preview",hi="exit";class pi{constructor(e){this.cleanUp=[],this.tokenStore=e.tokenStore,this.logger=e.logger}enable(){const e=new URL(window.location.href).searchParams.get(di);null!==e&&(this.updateToken(e),this.updateUrl(),setTimeout(this.updateUrl,500));const t=this.tokenStore.getToken();null!==t&&this.insertWidget(this.getWidgetUrl(t))}disable(){this.cleanUp.splice(0).forEach((e=>e()))}updateToken(e){if(e===hi)return this.logger.debug("Exiting preview mode."),void this.tokenStore.setToken(null);try{let t=dt.Token.parse(e);const{exp:n}=t.getPayload();void 0!==n&&n<=Date.now()/1e3&&(this.logger.debug("Preview token expired."),t=null),this.logger.debug("Preview token updated."),this.tokenStore.setToken(t)}catch(e){this.tokenStore.setToken(null),this.logger.warn(`Invalid preview token: ${Qe(e)}`)}}getWidgetUrl(e){let t=this.getWidgetParams(e).toString();return""!==t&&(t=`?${t}`),`https://cdn.croct.io/js/v1/lib/plug/widget-0.13.4.html${t}`}getWidgetParams(e){const{metadata:t={}}=e.getPayload(),n=new URLSearchParams;if(null===t||"object"!=typeof t||Array.isArray(t))return n;for(const[e,r]of Object.entries(pi.PREVIEW_PARAMS)){const i=t[e];"string"==typeof i&&n.set(r,i)}return n}insertWidget(e){const t=this.createWidget(e),n=e=>{if("https://cdn.croct.io"===e.origin)switch(e.data.type){case"croct:preview:leave":{this.tokenStore.setToken(null);const e=new URL(window.location.href);e.searchParams.set(di,hi),window.location.replace(e.toString());break}case"croct:preview:resize":t.style.width=`${e.data.width}px`,t.style.height=`${e.data.height}px`}};window.addEventListener("message",n),this.cleanUp.push((()=>window.removeEventListener("message",n)));const r=()=>{const e=document.body;e.prepend(t),this.cleanUp.push((()=>e.removeChild(t))),this.logger.debug("Preview widget mounted.");const n=new MutationObserver((()=>{e.contains(t)||(e.prepend(t),this.logger.debug("Preview widget removed from DOM, reinserting."))}));n.observe(e,{childList:!0}),this.cleanUp.unshift((()=>n.disconnect()))};"loading"!==document.readyState?r():(this.logger.debug("Waiting for document to be ready."),this.cleanUp.push((()=>window.removeEventListener("DOMContentLoaded",r))),window.addEventListener("DOMContentLoaded",r))}updateUrl(){const e=new URL(window.location.href);e.searchParams.has(di)&&(e.searchParams.delete(di),window.history.replaceState({},"",e.toString()))}createWidget(e){const t=document.createElement("iframe");return t.setAttribute("src",e),t.setAttribute("sandbox","allow-scripts allow-same-origin"),t.style.position="fixed",t.style.width="0px",t.style.height="0px",t.style.right="0",t.style.bottom="0",t.style.border="0",t.style.overflow="hidden",t.style.zIndex="2147483647",t}}pi.PREVIEW_PARAMS={previewMode:"previewMode",experienceName:"experience",experimentName:"experiment",audienceName:"audience",variantName:"variant",locale:"locale"};const gi=e=>{const{sdk:t}=e;return new pi({tokenStore:e.sdk.previewTokenStore,logger:t.getLogger()})},yi="Plugin";var mi=new class{constructor(){this.pluginFactories={playground:li,preview:gi},this.plugins={},this.ready=new Promise((e=>{this.initialize=e}))}extend(e,t){if(void 0!==this.pluginFactories[e])throw new Error(`Another plugin is already registered with name "${e}".`);this.pluginFactories[e]=t}plug(e={}){var t,n,r,i;if(void 0!==this.instance){return void this.instance.getLogger().info("Croct is already plugged in.")}const o=function(){const e=window.document.querySelector("script[src^='https://cdn.croct.io/js/v1/lib/plug.js']");return e instanceof HTMLScriptElement?new URL(e.src).searchParams.get("appId"):null}(),s=null!==(t=e.appId)&&void 0!==t?t:null;if(null!==o&&null!==s&&o!==s)throw new Error('The specified app ID and the auto-detected app ID are conflicting. There is no need to specify an app ID when using an application-specific tag. Please try again omitting the "appId" option.');const a=null!=o?o:s;if(null===a)throw new Error('The app ID must be specified when it cannot be auto-detected. Please try again specifying the "appId" option.');const{plugins:c,test:u,...l}=e,d=Wr.init({...l,appId:a,test:null!=u?u:"object"==typeof process&&(void 0!==(null===(n=process.env)||void 0===n?void 0:n.CROCT_TEST_MODE)?"true"===process.env.CROCT_TEST_MODE:"test"===(null===(r=process.env)||void 0===r?void 0:r.NODE_ENV))});this.instance=d;const h=this.instance.getLogger();o===s&&h.warn('It is strongly recommended omitting the "appId" option when using the application-specific tag as it is detected automatically.');const p=[],g=Object.fromEntries(Object.keys(this.pluginFactories).map((e=>[e,!0])));for(const[e,t]of Object.entries({...g,...c})){h.debug(`Initializing plugin "${e}"...`);const n=this.pluginFactories[e];if(void 0===n){h.error(`Plugin "${e}" is not registered.`);continue}if("boolean"!=typeof t&&(null===t||"object"!=typeof t)){h.error(`Invalid options for plugin "${e}", expected either boolean or object but got ${R.describe(t)}`);continue}if(!1===t){h.warn(`Plugin "${e}" is declared but not enabled`);continue}const r={options:!0===t?{}:t,sdk:{version:ai.VERSION,appId:a,tracker:d.tracker,evaluator:d.evaluator,user:d.user,session:d.session,tab:d.context.getTab(),userTokenStore:{getToken:d.getToken.bind(d),setToken:d.setToken.bind(d)},previewTokenStore:d.previewTokenStore,cidAssigner:d.cidAssigner,eventManager:d.eventManager,getLogger:(...t)=>d.getLogger(yi,e,...t),getTabStorage:(...t)=>d.getTabStorage(yi,e,...t),getBrowserStorage:(...t)=>d.getBrowserStorage(yi,e,...t)}};let i;try{i=n(r)}catch(t){h.error(`Failed to initialize plugin "${e}": ${Qe(t)}`);continue}if(h.debug(`Plugin "${e}" initialized`),"object"!=typeof i)continue;this.plugins[e]=i;const o=i.enable();o instanceof Promise?p.push(o.then((()=>h.debug(`Plugin "${e}" enabled`))).catch((t=>h.error(`Failed to enable plugin "${e}": ${Qe(t)}`)))):h.debug(`Plugin "${e}" enabled`)}const y=null===(i=window.croctEap)||void 0===i?void 0:i.initialize;"function"==typeof y&&y.call(this),Promise.all(p).then((()=>{this.initialize(),h.debug("Initialization complete")}))}get initialized(){return void 0!==this.instance}get plugged(){return this.ready.then((()=>this))}get flushed(){return this.tracker.flushed.then((()=>this))}get sdk(){if(void 0===this.instance)throw new Error("Croct is not plugged in.");return this.instance}get tracker(){return this.sdk.tracker}get evaluator(){return this.sdk.evaluator}get user(){return this.sdk.user}get session(){return this.sdk.session}isAnonymous(){return this.sdk.context.isAnonymous()}getUserId(){return this.sdk.context.getUser()}identify(e){if("string"!=typeof e)throw new Error("The user ID must be a string. Read more on https://croct.help/plug-js/id-conversion");this.sdk.identify(e)}anonymize(){this.sdk.anonymize()}setToken(e){this.sdk.setToken(dt.Token.parse(e))}unsetToken(){this.sdk.unsetToken()}track(e,t){return this.sdk.tracker.track(e,t)}evaluate(e,t={}){return this.sdk.evaluator.evaluate(e,t)}test(e,t={}){return this.evaluate(e,t).then((e=>!0===e))}get fetch(){return this.eap("fetch",((e,t={})=>{const[n,r="latest"]=e.split("@"),i=this.sdk.getLogger();return this.sdk.contentFetcher.fetch(n,"latest"===r?t:{...t,version:r}).then((e=>({get payload(){return i.warn('Accessing the "payload" property of the fetch response is deprecated and will be removed in a future version. Use the "content" property instead.'),e.content},content:e.content})))}))}async unplug(){if(void 0===this.instance)return;const{instance:e,plugins:t}=this,n=this.sdk.getLogger(),r=[];for(const[e,i]of Object.entries(t)){if("function"!=typeof i.disable)continue;n.debug(`Disabling plugin "${e}"...`);const t=i.disable();t instanceof Promise?r.push(t.then((()=>n.debug(`Plugin "${e}" disabled`))).catch((t=>n.error(`Failed to disable "${e}": ${Qe(t)}`)))):n.debug(`Plugin "${e}" disabled`)}delete this.instance,this.plugins={},this.ready=new Promise((e=>{this.initialize=e})),await Promise.all(r);try{await e.close()}finally{n.info("🔌 Croct has been unplugged.")}}eap(e,t){const n=window.croctEap,r="object"==typeof n?n[e]:void 0;return"function"!=typeof r?t:r.bind(new Proxy(this,{get:(n,r)=>r===e?t:n[r]}))}};return mi}();
